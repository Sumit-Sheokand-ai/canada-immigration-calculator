import{r as i,j as e}from"./vendor-react-Ah1pgjPn.js";import{u as Ae,f as J,j as X,k as Ee,s as Re,l as Z}from"./feature-path-coach-BhTfkEQA.js";import{r as Pe,c as Le,d as De,i as Ie,s as Me,e as Fe,f as Te,h as O,j as q}from"./index-xsxJh8bE.js";import{g as Oe,c as _}from"./questionDataSource-DrI8EsUl.js";import{r as ee,c as qe,d as _e}from"./feature-strategy-hub-DjfosD2y.js";import"./data-question-bank-BGQJyrDZ.js";import"./vendor-motion-CtNR3TjB.js";const te=/^\S+@\S+\.\S+$/,C="DELETE",se=8;function Ke({open:r,onClose:u}){const{isConfigured:y,loading:R,user:o,ensureAuthReady:U,sendEmailMagicLink:ae,verifyEmailOtp:ne,refreshSession:P,signInWithGoogle:ie,signOut:ce,updateProfile:oe,changePassword:re,deleteAccount:le}=Ae(),[B,de]=i.useState(""),[L,j]=i.useState(""),[f,p]=i.useState("request"),[V,n]=i.useState(""),[z,s]=i.useState(""),[b,N]=i.useState(0),[h,g]=i.useState(()=>Pe()),[v,x]=i.useState(()=>ee()),[D,I]=i.useState(()=>J()||""),[l,ue]=i.useState(()=>({drawSource:"unknown",drawFreshness:"unknown",drawUpdatedAt:"—",categorySource:"unknown",categoryFreshness:"unknown",categoryCount:0,questionSource:"unknown",questionFreshness:"unknown",questionCount:0,activePolicy:X(),refreshedAt:""})),[G,M]=i.useState(""),[Q,F]=i.useState(""),[$,T]=i.useState(""),K=i.useId(),he=i.useMemo(()=>o?"Account":"Login / Signup",[o]),me=i.useMemo(()=>Ee(),[]),W=Ie(),c=V!=="",d=t=>V===t,w=i.useCallback(async({forceRefresh:t=!1,silent:a=!1}={})=>{a||(n("refreshAdminMeta"),s(""));try{const[m,A,E]=await Promise.all([Le({forceRefresh:t}),De({forceRefresh:t}),Oe({forceRefresh:t})]);ue({drawSource:m?.source||"unknown",drawFreshness:m?.freshness||"unknown",drawUpdatedAt:m?.data?.lastUpdated||"—",categorySource:A?.source||"unknown",categoryFreshness:A?.freshness||"unknown",categoryCount:Array.isArray(A?.data)?A.data.length:0,questionSource:E?.source||"unknown",questionFreshness:E?.freshness||"unknown",questionCount:Array.isArray(E?.data)?E.data.length:0,activePolicy:X(),refreshedAt:new Date().toISOString()}),a||s("Admin metadata refreshed.")}catch(m){a||s(m.message||"Could not refresh admin metadata.")}finally{a||n("")}},[]);if(i.useEffect(()=>{!r||!y||U().catch(()=>{})},[U,y,r]),i.useEffect(()=>{if(!r||b<=0)return;const t=window.setInterval(()=>{N(a=>a<=1?0:a-1)},1e3);return()=>window.clearInterval(t)},[r,b]),i.useEffect(()=>{!r||!o||(g(t=>({...t,profileName:o.user_metadata?.full_name||t.profileName||"",contactEmail:t.contactEmail||o.email||""})),x(ee()),I(J()||""),w({silent:!0}))},[r,w,o]),i.useEffect(()=>{if(!r||!o||!(f==="sent"||f==="verify"))return;s("Signed in successfully.");const t=window.setTimeout(()=>u(),500);return()=>window.clearTimeout(t)},[u,r,f,o]),i.useEffect(()=>{r||(p("request"),j(""),s(""),n(""),N(0),M(""),F(""),T(""))},[r]),i.useEffect(()=>{if(!r)return;const t=document.body.style.overflow,a=m=>{m.key==="Escape"&&u()};return document.body.style.overflow="hidden",window.addEventListener("keydown",a),()=>{window.removeEventListener("keydown",a),document.body.style.overflow=t}},[u,r]),!r)return null;const k=B.trim().toLowerCase(),Y=$.trim().toUpperCase(),S=t=>{const a=document.getElementById(t);a&&a.scrollIntoView({behavior:"smooth",block:"start"})},H=async()=>{if(!k||!te.test(k)){s("Please enter a valid email address.");return}n("sendMagicLink"),s("");try{await ae(k),p("sent"),j(""),N(25),s("Magic link sent. Open your email and click the secure sign-in link.")}catch(t){s(t.message||"Could not send magic link.")}finally{n("")}},ge=async()=>{n("checkMagicLink"),s("");try{(await P())?.user?(s("Signed in successfully."),p("request"),window.setTimeout(()=>u(),500)):s("No active session found yet. Click the magic link from your email in this browser, then try again.")}catch(t){s(t.message||"Could not refresh session.")}finally{n("")}},fe=async()=>{b>0||await H()},ye=async()=>{if(!k||!L.trim()){s("Enter your email and 6-digit code.");return}n("verifyCode"),s("");try{await ne(k,L.trim()),await P(),s("Signed in successfully."),p("request"),j(""),window.setTimeout(()=>u(),500)}catch(t){s(t.message||"Verification failed.")}finally{n("")}},pe=async()=>{n("googleAuth"),s("");try{await ie(),s("Redirecting to Google...")}catch(t){s(t.message||"Google login failed.")}finally{n("")}},be=async()=>{const t={...h,profileName:(h.profileName||"").trim(),contactEmail:(h.contactEmail||"").trim().toLowerCase()};if(t.contactEmail&&!te.test(t.contactEmail)){s("Please enter a valid contact email.");return}n("saveSettings"),s("");try{await oe({fullName:t.profileName}),Me(t),g(t),W&&o?.id&&await Promise.all([Fe(o.id,t.defaultDrawAlerts),Te(o.id,t.contactEmail||o.email||"")]),s("Account settings saved.")}catch(a){s(a.message||"Could not save account settings.")}finally{n("")}},xe=async()=>{const t=G.trim(),a=Q.trim();if(t.length<se){s(`Password must be at least ${se} characters.`);return}if(t!==a){s("New password and confirmation do not match.");return}n("changePassword"),s("");try{await re(t),M(""),F(""),s("Password updated successfully.")}catch(m){s(m.message||"Could not change password.")}finally{n("")}},we=()=>{{s("Membership management is unavailable. Add VITE_STRIPE_BILLING_PORTAL_URL.");return}},je=async()=>{if(Y!==C){s(`Type ${C} to confirm account deletion.`);return}n("deleteAccount"),s("");try{await le(),T(""),s("Account deleted."),window.setTimeout(()=>u(),350)}catch(t){s(t.message||"Could not delete account.")}finally{n("")}},ve=async()=>{n("refreshSession"),s("");try{await P(),s("Session refreshed.")}catch(t){s(t.message||"Session refresh failed.")}finally{n("")}},ke=async()=>{n("signOut"),s("");try{await ce(),s("Signed out."),window.setTimeout(()=>u(),400)}catch(t){s(t.message||"Sign out failed.")}finally{n("")}},Ce=async()=>{n("saveAdminControls"),s("");try{qe(v),D?Re(D):Z(),O(),q(),_(),await w({forceRefresh:!0,silent:!0}),s("Admin controls saved.")}catch(t){s(t.message||"Could not save admin controls.")}finally{n("")}},Ne=async()=>{n("resetAdminControls"),s("");try{x(_e()),Z(),I(""),O(),q(),_(),await w({forceRefresh:!0,silent:!0}),s("Admin controls reset to defaults.")}catch(t){s(t.message||"Could not reset admin controls.")}finally{n("")}},Se=async()=>{n("clearAdminCaches"),s("");try{O(),q(),_(),await w({forceRefresh:!0,silent:!0}),s("Draw/category/question caches cleared.")}catch(t){s(t.message||"Could not clear caches.")}finally{n("")}};return e.jsx("div",{className:"auth-modal-backdrop",onClick:u,role:"presentation",children:e.jsxs("div",{className:"auth-modal",role:"dialog","aria-modal":"true","aria-labelledby":K,onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"auth-modal-head",children:[e.jsx("h3",{id:K,children:he}),e.jsx("button",{type:"button",className:"auth-close",onClick:u,"aria-label":"Close dialog",children:"×"})]}),e.jsxs("div",{className:"auth-modal-scroll",children:[!y&&e.jsx("p",{className:"auth-note",children:"Auth is unavailable. Add `VITE_SUPABASE_URL` and `VITE_SUPABASE_ANON_KEY`."}),y&&R&&e.jsx("p",{className:"auth-note",children:"Checking session..."}),y&&!R&&o&&e.jsxs("div",{className:"auth-body",children:[e.jsxs("p",{className:"auth-note",children:["Signed in as ",e.jsx("strong",{children:o.email})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section",children:[e.jsx("h4",{children:"Account actions"}),e.jsxs("div",{className:"auth-action-shortcuts",children:[e.jsx("button",{type:"button",className:"action-btn",onClick:()=>S("auth-security"),children:"Change password"}),e.jsx("button",{type:"button",className:"action-btn",onClick:()=>S("auth-admin"),children:"Admin controls"}),e.jsx("button",{type:"button",className:"action-btn",onClick:()=>S("auth-membership"),children:"Remove membership"}),e.jsx("button",{type:"button",className:"action-btn auth-btn-danger",onClick:()=>S("auth-danger-zone"),children:"Delete account"})]})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section",children:[e.jsx("h4",{children:"Account settings"}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Display name"}),e.jsx("input",{type:"text",value:h.profileName,onChange:t=>g(a=>({...a,profileName:t.target.value})),placeholder:"Your name"})]}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Contact email for draw alerts"}),e.jsx("input",{type:"email",value:h.contactEmail,onChange:t=>g(a=>({...a,contactEmail:t.target.value})),placeholder:"you@example.com"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:h.defaultDrawAlerts,onChange:t=>g(a=>({...a,defaultDrawAlerts:t.target.checked}))}),e.jsx("span",{children:"Enable draw alerts by default"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:h.autoSyncProfiles,onChange:t=>g(a=>({...a,autoSyncProfiles:t.target.checked}))}),e.jsx("span",{children:"Auto-sync saved profiles"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:h.autoSaveProgress,onChange:t=>g(a=>({...a,autoSaveProgress:t.target.checked}))}),e.jsx("span",{children:"Auto-save wizard progress on this device"})]}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Animation intensity"}),e.jsxs("select",{value:h.motionIntensity||"full",onChange:t=>g(a=>({...a,motionIntensity:t.target.value})),children:[e.jsx("option",{value:"full",children:"Full"}),e.jsx("option",{value:"subtle",children:"Subtle"}),e.jsx("option",{value:"off",children:"Off"})]})]}),!W&&e.jsx("p",{className:"auth-note",children:"Cloud account settings require Supabase env vars."})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section",id:"auth-admin",children:[e.jsx("h4",{children:"Admin controls"}),e.jsx("p",{className:"auth-note",children:"Runtime controls for data mode, policy versioning, and source metadata."}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:v.forceLocalData,onChange:t=>x(a=>({...a,forceLocalData:t.target.checked}))}),e.jsx("span",{children:"Force local data mode (disable remote Supabase reads)"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:v.allowRemoteQuestionBank,onChange:t=>x(a=>({...a,allowRemoteQuestionBank:t.target.checked}))}),e.jsx("span",{children:"Allow remote question-bank payloads"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:v.enableAdvancedForecasting,onChange:t=>x(a=>({...a,enableAdvancedForecasting:t.target.checked}))}),e.jsx("span",{children:"Enable advanced trend forecasting widgets"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:v.enablePerfTelemetry,onChange:t=>x(a=>({...a,enablePerfTelemetry:t.target.checked}))}),e.jsx("span",{children:"Enable route/performance telemetry events"})]}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Scoring policy override"}),e.jsxs("select",{value:D,onChange:t=>I(t.target.value),children:[e.jsx("option",{value:"",children:"Automatic (effective-date ruleset)"}),me.map(t=>e.jsxs("option",{value:t.id,children:[t.id," · effective ",t.effectiveDate]},t.id))]})]}),e.jsxs("div",{className:"auth-admin-meta",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Active policy:"})," ",l.activePolicy?.id||"—"," (",l.activePolicy?.source||"unknown",")"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Draw source:"})," ",l.drawSource," (",l.drawFreshness,") · Updated ",l.drawUpdatedAt]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Category source:"})," ",l.categorySource," (",l.categoryFreshness,") · ",l.categoryCount," categories"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Question bank:"})," ",l.questionSource," (",l.questionFreshness,") · ",l.questionCount," steps"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Metadata refreshed:"})," ",l.refreshedAt?new Date(l.refreshedAt).toLocaleString():"—"]})]}),e.jsxs("div",{className:"auth-actions",children:[e.jsx("button",{type:"button",className:"action-btn auth-btn-primary",disabled:c,onClick:Ce,children:d("saveAdminControls")?"Saving controls...":"Save controls"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:()=>{w({forceRefresh:!0})},children:d("refreshAdminMeta")?"Refreshing metadata...":"Refresh metadata"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:Se,children:d("clearAdminCaches")?"Clearing caches...":"Clear caches"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:Ne,children:d("resetAdminControls")?"Resetting...":"Reset controls"})]})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section",id:"auth-security",children:[e.jsx("h4",{children:"Security"}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"New password"}),e.jsx("input",{type:"password",value:G,onChange:t=>M(t.target.value),placeholder:"At least 8 characters",autoComplete:"new-password"})]}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Confirm new password"}),e.jsx("input",{type:"password",value:Q,onChange:t=>F(t.target.value),placeholder:"Re-enter new password",autoComplete:"new-password"})]}),e.jsx("div",{className:"auth-actions",children:e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:xe,children:d("changePassword")?"Updating...":"Change password"})})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section",id:"auth-membership",children:[e.jsx("h4",{children:"Membership"}),e.jsx("p",{className:"auth-note",children:"Remove or manage your membership from the billing portal."}),e.jsx("div",{className:"auth-actions",children:e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:we,children:"Remove membership"})})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section auth-danger-zone",id:"auth-danger-zone",children:[e.jsx("h4",{children:"Danger zone"}),e.jsxs("p",{className:"auth-note",children:["This permanently deletes your account. Type ",e.jsx("strong",{children:C})," to confirm."]}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Confirmation"}),e.jsx("input",{type:"text",value:$,onChange:t=>T(t.target.value),placeholder:C})]}),e.jsx("div",{className:"auth-actions",children:e.jsx("button",{type:"button",className:"action-btn auth-btn-danger",disabled:c||Y!==C,onClick:je,children:d("deleteAccount")?"Deleting...":"Delete account"})})]}),e.jsxs("div",{className:"auth-actions",children:[e.jsx("button",{type:"button",className:"action-btn auth-btn-primary",disabled:c,onClick:be,children:d("saveSettings")?"Saving...":"Save settings"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:ve,children:d("refreshSession")?"Refreshing...":"Refresh session"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:ke,children:d("signOut")?"Signing out...":"Sign out"})]})]}),y&&!R&&!o&&e.jsxs("div",{className:"auth-body",children:[e.jsx("p",{className:"auth-note",children:"Sign in with a magic link (recommended) or verify manually with an email code."}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Email"}),e.jsx("input",{type:"email",placeholder:"you@example.com",value:B,onChange:t=>de(t.target.value),autoFocus:!0})]}),f==="verify"&&e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Email verification code"}),e.jsx("input",{type:"text",inputMode:"numeric",placeholder:"Enter code",value:L,onChange:t=>j(t.target.value)})]}),e.jsxs("div",{className:"auth-actions",children:[f==="request"?e.jsx("button",{type:"button",className:"action-btn auth-btn-primary",disabled:c,onClick:H,children:d("sendMagicLink")?"Sending...":"Send magic link"}):f==="sent"?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"action-btn auth-btn-primary",disabled:c,onClick:ge,children:d("checkMagicLink")?"Checking...":"I clicked the magic link"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c||b>0,onClick:fe,children:b>0?`Resend in ${b}s`:"Resend magic link"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:()=>{p("verify"),s("If your email contains a code, enter it below.")},children:"Use email code instead"})]}):e.jsx("button",{type:"button",className:"action-btn auth-btn-primary",disabled:c,onClick:ye,children:d("verifyCode")?"Verifying...":"Verify and sign in"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:pe,children:d("googleAuth")?"Redirecting...":"Continue with Google"}),f!=="request"&&e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:()=>{p("request"),j(""),s(""),N(0)},children:"Back"})]})]}),z&&e.jsx("p",{className:"auth-status",role:"status","aria-live":"polite",children:z})]})]})})}export{Ke as default};
