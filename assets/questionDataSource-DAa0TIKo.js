import{u as f}from"./data-question-bank-CHMn2w4n.js";import{i as S,g as b}from"./feature-path-coach-zUOL8Yd7.js";import{r as p}from"./feature-strategy-hub-DDUytvFw.js";const A=300*1e3,h="crs-cache-question-bank-v1";let a={data:null,source:"none",fetchedAt:0},c=!1;function m(e){if(!e||typeof e!="object")return null;const t=String(e.value??"").trim(),r=String(e.label??"").trim();if(!t||!r)return null;const n=typeof e.example=="string"?e.example:"",o=Array.isArray(e.keywords)?e.keywords.map(s=>String(s)):[];return{value:t,label:r,example:n,keywords:o}}function w(){try{const e=localStorage.getItem(h);return e?JSON.parse(e):null}catch{return null}}function k(e){try{localStorage.setItem(h,JSON.stringify(e))}catch{}}function C(){try{localStorage.removeItem(h)}catch{}}function B(e){return Number.isFinite(e)&&e>0&&Date.now()-e<A}function l(e,{revalidating:t=!1}={}){return{status:"ok",source:e.source,data:e.data,fetchedAt:e.fetchedAt,freshness:B(e.fetchedAt)?"fresh":"stale",revalidating:t}}function y(){if(c)return;c=!0;const e=w(),t=g(e?.data),r=Number(e?.fetchedAt||0);!t||!Number.isFinite(r)||r<=0||(a={data:t,source:String(e?.source||"supabase-cache"),fetchedAt:r})}function u(e,t){a={data:e,source:t,fetchedAt:Date.now()},k({data:e,source:t,fetchedAt:a.fetchedAt})}function Q(e){if(!e||typeof e!="object")return null;const t=String(e.answerKey??"").trim(),r=String(e.title??"").trim();if(!t||!r)return null;const n=String(e.type||"list"),o=Array.isArray(e.options)?e.options.map(m).filter(Boolean):[];return{title:r,answerKey:t,type:n,searchable:!!e.searchable,searchPlaceholder:typeof e.searchPlaceholder=="string"?e.searchPlaceholder:"",options:o}}function z(e){if(!e||typeof e!="object")return;const t=s=>Array.isArray(s)?s.filter(i=>i&&typeof i=="object"&&i.key).map(i=>({key:String(i.key),op:String(i.op||"eq"),value:i.value})):[],r=t(e.all),n=t(e.any),o=t(e.none);if(!(!r.length&&!n.length&&!o.length))return{all:r,any:n,none:o}}function v(e){if(!e||typeof e!="object")return null;const t=String(e.id??"").trim(),r=String(e.type??"").trim();if(!t||!r)return null;const n={id:t,label:String(e.label??""),title:String(e.title??""),subtitle:String(e.subtitle??""),helpTip:String(e.helpTip??""),type:r,answerKey:String(e.answerKey??""),layout:String(e.layout??""),searchable:!!e.searchable,searchPlaceholder:String(e.searchPlaceholder??""),hasNOCSearch:!!e.hasNOCSearch,visibility:z(e.visibility)};if(r==="grouped"){if(n.groups=Array.isArray(e.groups)?e.groups.map(Q).filter(Boolean):[],!n.groups.length)return null}else if(n.options=Array.isArray(e.options)?e.options.map(m).filter(Boolean):[],!n.answerKey||!n.options.length)return null;return n}function g(e){let t=[];Array.isArray(e)?t=e:e&&typeof e=="object"&&Array.isArray(e.steps)&&(t=e.steps);const r=t.map(v).filter(Boolean);return r.length>0?r:null}function K(){return y(),a.data?l(a):l({data:f,source:"local-fallback",fetchedAt:0})}function O(){a={data:null,source:"none",fetchedAt:0},c=!0,C()}async function d(){if(S)try{const e=await b();if(!e)throw new Error("Supabase client unavailable");const{data:t,error:r}=await e.from("question_sets").select("id,source,version,payload,updated_at").eq("is_active",!0).order("updated_at",{ascending:!1}).limit(1);if(!r){const n=t?.[0],o=g(n?.payload);if(o)return u(o,"supabase"),l(a)}}catch{}return a.data||u(f,"local-fallback"),l(a)}function N(e,t){typeof e=="function"&&e(t)}async function R({forceRefresh:e=!1,staleWhileRevalidate:t=!0,onRevalidated:r=null}={}){const n=p();if(n.forceLocalData||!n.allowRemoteQuestionBank)return u(f,n.forceLocalData?"local-forced":"local-config"),l(a);if(y(),!e&&a.data){const s=l(a);return s.freshness==="fresh"||!t?s:(d().then(i=>N(r,i)).catch(()=>{}),{...s,revalidating:!0})}return await d()}export{O as c,R as g,K as p};
