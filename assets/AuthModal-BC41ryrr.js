import{r as i,j as e}from"./vendor-react-Ah1pgjPn.js";import{u as Se,e as H,f as J,j as Ae,k as Ee,l as X}from"./feature-path-coach-BX4hFirh.js";import{r as Re,b as Pe,c as Le,i as De,s as Ie,d as Me,e as Te,f as q,h as _}from"./index-B1HuAafA.js";import{g as Oe,c as U}from"./questionDataSource-BuXYi3JR.js";import{r as Z,s as qe,a as _e}from"./feature-strategy-hub-Dpiw6aLk.js";import"./data-question-bank-BGQJyrDZ.js";import"./vendor-supabase-BZ0N5lZN.js";import"./vendor-motion-DURBmaq0.js";const ee=/^\S+@\S+\.\S+$/,C="DELETE",te=8;function Ke({open:l,onClose:d}){const{isConfigured:k,loading:A,user:o,sendEmailMagicLink:ae,verifyEmailOtp:se,refreshSession:E,signInWithGoogle:ne,signOut:ie,updateProfile:ce,changePassword:oe,deleteAccount:re}=Se(),[F,le]=i.useState(""),[R,w]=i.useState(""),[f,y]=i.useState("request"),[B,n]=i.useState(""),[V,a]=i.useState(""),[p,N]=i.useState(0),[h,m]=i.useState(()=>Re()),[j,b]=i.useState(()=>Z()),[P,L]=i.useState(()=>H()||""),[u,de]=i.useState(()=>({drawSource:"unknown",drawUpdatedAt:"—",categorySource:"unknown",categoryCount:0,questionSource:"unknown",questionCount:0,activePolicy:J(),refreshedAt:""})),[z,D]=i.useState(""),[G,I]=i.useState(""),[Q,M]=i.useState(""),$=i.useId(),ue=i.useMemo(()=>o?"Account":"Login / Signup",[o]),he=i.useMemo(()=>Ae(),[]),K=De(),c=B!=="",r=t=>B===t,x=i.useCallback(async({forceRefresh:t=!1,silent:s=!1}={})=>{s||(n("refreshAdminMeta"),a(""));try{const[g,T,O]=await Promise.all([Pe({forceRefresh:t}),Le({forceRefresh:t}),Oe({forceRefresh:t})]);de({drawSource:g?.source||"unknown",drawUpdatedAt:g?.data?.lastUpdated||"—",categorySource:T?.source||"unknown",categoryCount:Array.isArray(T?.data)?T.data.length:0,questionSource:O?.source||"unknown",questionCount:Array.isArray(O?.data)?O.data.length:0,activePolicy:J(),refreshedAt:new Date().toISOString()}),s||a("Admin metadata refreshed.")}catch(g){s||a(g.message||"Could not refresh admin metadata.")}finally{s||n("")}},[]);if(i.useEffect(()=>{if(!l||p<=0)return;const t=window.setInterval(()=>{N(s=>s<=1?0:s-1)},1e3);return()=>window.clearInterval(t)},[l,p]),i.useEffect(()=>{!l||!o||(m(t=>({...t,profileName:o.user_metadata?.full_name||t.profileName||"",contactEmail:t.contactEmail||o.email||""})),b(Z()),L(H()||""),x({silent:!0}))},[l,x,o]),i.useEffect(()=>{if(!l||!o||!(f==="sent"||f==="verify"))return;a("Signed in successfully.");const t=window.setTimeout(()=>d(),500);return()=>window.clearTimeout(t)},[d,l,f,o]),i.useEffect(()=>{l||(y("request"),w(""),a(""),n(""),N(0),D(""),I(""),M(""))},[l]),i.useEffect(()=>{if(!l)return;const t=document.body.style.overflow,s=g=>{g.key==="Escape"&&d()};return document.body.style.overflow="hidden",window.addEventListener("keydown",s),()=>{window.removeEventListener("keydown",s),document.body.style.overflow=t}},[d,l]),!l)return null;const v=F.trim().toLowerCase(),W=Q.trim().toUpperCase(),S=t=>{const s=document.getElementById(t);s&&s.scrollIntoView({behavior:"smooth",block:"start"})},Y=async()=>{if(!v||!ee.test(v)){a("Please enter a valid email address.");return}n("sendMagicLink"),a("");try{await ae(v),y("sent"),w(""),N(25),a("Magic link sent. Open your email and click the secure sign-in link.")}catch(t){a(t.message||"Could not send magic link.")}finally{n("")}},me=async()=>{n("checkMagicLink"),a("");try{(await E())?.user?(a("Signed in successfully."),y("request"),window.setTimeout(()=>d(),500)):a("No active session found yet. Click the magic link from your email in this browser, then try again.")}catch(t){a(t.message||"Could not refresh session.")}finally{n("")}},ge=async()=>{p>0||await Y()},fe=async()=>{if(!v||!R.trim()){a("Enter your email and 6-digit code.");return}n("verifyCode"),a("");try{await se(v,R.trim()),await E(),a("Signed in successfully."),y("request"),w(""),window.setTimeout(()=>d(),500)}catch(t){a(t.message||"Verification failed.")}finally{n("")}},ye=async()=>{n("googleAuth"),a("");try{await ne(),a("Redirecting to Google...")}catch(t){a(t.message||"Google login failed.")}finally{n("")}},pe=async()=>{const t={...h,profileName:(h.profileName||"").trim(),contactEmail:(h.contactEmail||"").trim().toLowerCase()};if(t.contactEmail&&!ee.test(t.contactEmail)){a("Please enter a valid contact email.");return}n("saveSettings"),a("");try{await ce({fullName:t.profileName}),Ie(t),m(t),K&&o?.id&&await Promise.all([Me(o.id,t.defaultDrawAlerts),Te(o.id,t.contactEmail||o.email||"")]),a("Account settings saved.")}catch(s){a(s.message||"Could not save account settings.")}finally{n("")}},be=async()=>{const t=z.trim(),s=G.trim();if(t.length<te){a(`Password must be at least ${te} characters.`);return}if(t!==s){a("New password and confirmation do not match.");return}n("changePassword"),a("");try{await oe(t),D(""),I(""),a("Password updated successfully.")}catch(g){a(g.message||"Could not change password.")}finally{n("")}},xe=()=>{{a("Membership management is unavailable. Add VITE_STRIPE_BILLING_PORTAL_URL.");return}},we=async()=>{if(W!==C){a(`Type ${C} to confirm account deletion.`);return}n("deleteAccount"),a("");try{await re(),M(""),a("Account deleted."),window.setTimeout(()=>d(),350)}catch(t){a(t.message||"Could not delete account.")}finally{n("")}},je=async()=>{n("refreshSession"),a("");try{await E(),a("Session refreshed.")}catch(t){a(t.message||"Session refresh failed.")}finally{n("")}},ve=async()=>{n("signOut"),a("");try{await ie(),a("Signed out."),window.setTimeout(()=>d(),400)}catch(t){a(t.message||"Sign out failed.")}finally{n("")}},Ce=async()=>{n("saveAdminControls"),a("");try{qe(j),P?Ee(P):X(),q(),_(),U(),await x({forceRefresh:!0,silent:!0}),a("Admin controls saved.")}catch(t){a(t.message||"Could not save admin controls.")}finally{n("")}},ke=async()=>{n("resetAdminControls"),a("");try{b(_e()),X(),L(""),q(),_(),U(),await x({forceRefresh:!0,silent:!0}),a("Admin controls reset to defaults.")}catch(t){a(t.message||"Could not reset admin controls.")}finally{n("")}},Ne=async()=>{n("clearAdminCaches"),a("");try{q(),_(),U(),await x({forceRefresh:!0,silent:!0}),a("Draw/category/question caches cleared.")}catch(t){a(t.message||"Could not clear caches.")}finally{n("")}};return e.jsx("div",{className:"auth-modal-backdrop",onClick:d,role:"presentation",children:e.jsxs("div",{className:"auth-modal",role:"dialog","aria-modal":"true","aria-labelledby":$,onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"auth-modal-head",children:[e.jsx("h3",{id:$,children:ue}),e.jsx("button",{type:"button",className:"auth-close",onClick:d,"aria-label":"Close dialog",children:"×"})]}),e.jsxs("div",{className:"auth-modal-scroll",children:[!k&&e.jsx("p",{className:"auth-note",children:"Auth is unavailable. Add `VITE_SUPABASE_URL` and `VITE_SUPABASE_ANON_KEY`."}),k&&A&&e.jsx("p",{className:"auth-note",children:"Checking session..."}),k&&!A&&o&&e.jsxs("div",{className:"auth-body",children:[e.jsxs("p",{className:"auth-note",children:["Signed in as ",e.jsx("strong",{children:o.email})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section",children:[e.jsx("h4",{children:"Account actions"}),e.jsxs("div",{className:"auth-action-shortcuts",children:[e.jsx("button",{type:"button",className:"action-btn",onClick:()=>S("auth-security"),children:"Change password"}),e.jsx("button",{type:"button",className:"action-btn",onClick:()=>S("auth-admin"),children:"Admin controls"}),e.jsx("button",{type:"button",className:"action-btn",onClick:()=>S("auth-membership"),children:"Remove membership"}),e.jsx("button",{type:"button",className:"action-btn auth-btn-danger",onClick:()=>S("auth-danger-zone"),children:"Delete account"})]})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section",children:[e.jsx("h4",{children:"Account settings"}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Display name"}),e.jsx("input",{type:"text",value:h.profileName,onChange:t=>m(s=>({...s,profileName:t.target.value})),placeholder:"Your name"})]}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Contact email for draw alerts"}),e.jsx("input",{type:"email",value:h.contactEmail,onChange:t=>m(s=>({...s,contactEmail:t.target.value})),placeholder:"you@example.com"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:h.defaultDrawAlerts,onChange:t=>m(s=>({...s,defaultDrawAlerts:t.target.checked}))}),e.jsx("span",{children:"Enable draw alerts by default"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:h.autoSyncProfiles,onChange:t=>m(s=>({...s,autoSyncProfiles:t.target.checked}))}),e.jsx("span",{children:"Auto-sync saved profiles"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:h.autoSaveProgress,onChange:t=>m(s=>({...s,autoSaveProgress:t.target.checked}))}),e.jsx("span",{children:"Auto-save wizard progress on this device"})]}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Animation intensity"}),e.jsxs("select",{value:h.motionIntensity||"full",onChange:t=>m(s=>({...s,motionIntensity:t.target.value})),children:[e.jsx("option",{value:"full",children:"Full"}),e.jsx("option",{value:"subtle",children:"Subtle"}),e.jsx("option",{value:"off",children:"Off"})]})]}),!K&&e.jsx("p",{className:"auth-note",children:"Cloud account settings require Supabase env vars."})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section",id:"auth-admin",children:[e.jsx("h4",{children:"Admin controls"}),e.jsx("p",{className:"auth-note",children:"Runtime controls for data mode, policy versioning, and source metadata."}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:j.forceLocalData,onChange:t=>b(s=>({...s,forceLocalData:t.target.checked}))}),e.jsx("span",{children:"Force local data mode (disable remote Supabase reads)"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:j.allowRemoteQuestionBank,onChange:t=>b(s=>({...s,allowRemoteQuestionBank:t.target.checked}))}),e.jsx("span",{children:"Allow remote question-bank payloads"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:j.enableAdvancedForecasting,onChange:t=>b(s=>({...s,enableAdvancedForecasting:t.target.checked}))}),e.jsx("span",{children:"Enable advanced trend forecasting widgets"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:j.enablePerfTelemetry,onChange:t=>b(s=>({...s,enablePerfTelemetry:t.target.checked}))}),e.jsx("span",{children:"Enable route/performance telemetry events"})]}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Scoring policy override"}),e.jsxs("select",{value:P,onChange:t=>L(t.target.value),children:[e.jsx("option",{value:"",children:"Automatic (effective-date ruleset)"}),he.map(t=>e.jsxs("option",{value:t.id,children:[t.id," · effective ",t.effectiveDate]},t.id))]})]}),e.jsxs("div",{className:"auth-admin-meta",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Active policy:"})," ",u.activePolicy?.id||"—"," (",u.activePolicy?.source||"unknown",")"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Draw source:"})," ",u.drawSource," · Updated ",u.drawUpdatedAt]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Category source:"})," ",u.categorySource," · ",u.categoryCount," categories"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Question bank:"})," ",u.questionSource," · ",u.questionCount," steps"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Metadata refreshed:"})," ",u.refreshedAt?new Date(u.refreshedAt).toLocaleString():"—"]})]}),e.jsxs("div",{className:"auth-actions",children:[e.jsx("button",{type:"button",className:"action-btn auth-btn-primary",disabled:c,onClick:Ce,children:r("saveAdminControls")?"Saving controls...":"Save controls"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:()=>{x({forceRefresh:!0})},children:r("refreshAdminMeta")?"Refreshing metadata...":"Refresh metadata"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:Ne,children:r("clearAdminCaches")?"Clearing caches...":"Clear caches"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:ke,children:r("resetAdminControls")?"Resetting...":"Reset controls"})]})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section",id:"auth-security",children:[e.jsx("h4",{children:"Security"}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"New password"}),e.jsx("input",{type:"password",value:z,onChange:t=>D(t.target.value),placeholder:"At least 8 characters",autoComplete:"new-password"})]}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Confirm new password"}),e.jsx("input",{type:"password",value:G,onChange:t=>I(t.target.value),placeholder:"Re-enter new password",autoComplete:"new-password"})]}),e.jsx("div",{className:"auth-actions",children:e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:be,children:r("changePassword")?"Updating...":"Change password"})})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section",id:"auth-membership",children:[e.jsx("h4",{children:"Membership"}),e.jsx("p",{className:"auth-note",children:"Remove or manage your membership from the billing portal."}),e.jsx("div",{className:"auth-actions",children:e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:xe,children:"Remove membership"})})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section auth-danger-zone",id:"auth-danger-zone",children:[e.jsx("h4",{children:"Danger zone"}),e.jsxs("p",{className:"auth-note",children:["This permanently deletes your account. Type ",e.jsx("strong",{children:C})," to confirm."]}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Confirmation"}),e.jsx("input",{type:"text",value:Q,onChange:t=>M(t.target.value),placeholder:C})]}),e.jsx("div",{className:"auth-actions",children:e.jsx("button",{type:"button",className:"action-btn auth-btn-danger",disabled:c||W!==C,onClick:we,children:r("deleteAccount")?"Deleting...":"Delete account"})})]}),e.jsxs("div",{className:"auth-actions",children:[e.jsx("button",{type:"button",className:"action-btn auth-btn-primary",disabled:c,onClick:pe,children:r("saveSettings")?"Saving...":"Save settings"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:je,children:r("refreshSession")?"Refreshing...":"Refresh session"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:ve,children:r("signOut")?"Signing out...":"Sign out"})]})]}),k&&!A&&!o&&e.jsxs("div",{className:"auth-body",children:[e.jsx("p",{className:"auth-note",children:"Sign in with a magic link (recommended) or verify manually with an email code."}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Email"}),e.jsx("input",{type:"email",placeholder:"you@example.com",value:F,onChange:t=>le(t.target.value),autoFocus:!0})]}),f==="verify"&&e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Email verification code"}),e.jsx("input",{type:"text",inputMode:"numeric",placeholder:"Enter code",value:R,onChange:t=>w(t.target.value)})]}),e.jsxs("div",{className:"auth-actions",children:[f==="request"?e.jsx("button",{type:"button",className:"action-btn auth-btn-primary",disabled:c,onClick:Y,children:r("sendMagicLink")?"Sending...":"Send magic link"}):f==="sent"?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"action-btn auth-btn-primary",disabled:c,onClick:me,children:r("checkMagicLink")?"Checking...":"I clicked the magic link"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c||p>0,onClick:ge,children:p>0?`Resend in ${p}s`:"Resend magic link"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:()=>{y("verify"),a("If your email contains a code, enter it below.")},children:"Use email code instead"})]}):e.jsx("button",{type:"button",className:"action-btn auth-btn-primary",disabled:c,onClick:fe,children:r("verifyCode")?"Verifying...":"Verify and sign in"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:ye,children:r("googleAuth")?"Redirecting...":"Continue with Google"}),f!=="request"&&e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:()=>{y("request"),w(""),a(""),N(0)},children:"Back"})]})]}),V&&e.jsx("p",{className:"auth-status",role:"status","aria-live":"polite",children:V})]})]})})}export{Ke as default};
