(function(){"use strict";const be={17:[0,0],18:[99,90],19:[105,95],20:[110,100],21:[110,100],22:[110,100],23:[110,100],24:[110,100],25:[110,100],26:[110,100],27:[110,100],28:[110,100],29:[110,100],30:[105,95],31:[99,90],32:[94,85],33:[88,80],34:[83,75],35:[77,70],36:[72,65],37:[66,60],38:[61,55],39:[55,50],40:[50,45],41:[39,35],42:[28,25],43:[17,15],44:[6,5],45:[0,0],46:[0,0],47:[0,0]},ke={less_than_secondary:[0,0],secondary:[30,28],one_year_post:[90,84],two_year_post:[98,91],bachelors:[120,112],two_or_more:[128,119],masters:[135,126],doctoral:[150,140]},we={0:[0,0],1:[0,0],2:[0,0],3:[0,0],4:[6,6],5:[6,6],6:[9,8],7:[17,16],8:[23,22],9:[31,29],10:[34,32],11:[34,32],12:[34,32]},Se={0:[0,0],1:[0,0],2:[0,0],3:[0,0],4:[0,0],5:[1,1],6:[1,1],7:[3,3],8:[3,3],9:[6,6],10:[6,6],11:[6,6],12:[6,6]},Ce={0:[0,0],1:[40,35],2:[53,46],3:[64,56],4:[72,63],5:[80,70]},ve={less_than_secondary:0,secondary:2,one_year_post:6,two_year_post:7,bachelors:8,two_or_more:9,masters:10,doctoral:10},Me={0:0,1:0,2:0,3:0,4:1,5:1,6:1,7:3,8:3,9:5,10:5,11:5,12:5},xe={0:0,1:5,2:7,3:8,4:9,5:10},Pe={reading:[{min:8,clb:10},{min:7,clb:9},{min:6.5,clb:8},{min:6,clb:7},{min:5,clb:6},{min:4,clb:5},{min:3.5,clb:4}],writing:[{min:7.5,clb:10},{min:7,clb:9},{min:6.5,clb:8},{min:6,clb:7},{min:5.5,clb:6},{min:5,clb:5},{min:4,clb:4}],listening:[{min:8.5,clb:10},{min:8,clb:9},{min:7.5,clb:8},{min:6,clb:7},{min:5.5,clb:6},{min:5,clb:5},{min:4.5,clb:4}],speaking:[{min:7.5,clb:10},{min:7,clb:9},{min:6.5,clb:8},{min:6,clb:7},{min:5.5,clb:6},{min:5,clb:5},{min:4,clb:4}]};function Le(e,t){const n=Pe[e];if(!n)return 0;for(const i of n)if(t>=i.min)return i.clb;return 0}const _e={less_than_secondary:0,secondary:0,one_year_post:1,two_year_post:2,bachelors:3,two_or_more:3,masters:3,doctoral:3},Te=[[0,0,0],[0,13,25],[0,25,50],[0,25,50]],Fe=[[0,0,0],[0,13,25],[0,25,50],[0,25,50]],Ie=[[0,0,0],[0,13,25],[0,25,50]],$e=[[0,0,0],[0,13,25],[0,25,50]],We=[0,25,50],De={pnp_nomination:600,job_offer_00:0,job_offer_other:0,canadian_edu_short:15,canadian_edu_long:30,sibling_in_canada:15,french_strong_weak_english:25,french_strong_strong_english:50},ne={averageCutoff:516},Ee={listening:[{min:360,nclc:10},{min:349,nclc:9},{min:334,nclc:8},{min:316,nclc:7},{min:298,nclc:6},{min:280,nclc:5},{min:249,nclc:4},{min:217,nclc:3},{min:181,nclc:2},{min:145,nclc:1}],reading:[{min:310,nclc:10},{min:294,nclc:9},{min:278,nclc:8},{min:263,nclc:7},{min:248,nclc:6},{min:233,nclc:5},{min:207,nclc:4},{min:181,nclc:3},{min:151,nclc:2},{min:121,nclc:1}],writing:[{min:450,nclc:10},{min:437,nclc:9},{min:415,nclc:8},{min:393,nclc:7},{min:371,nclc:6},{min:349,nclc:5},{min:310,nclc:4},{min:271,nclc:3},{min:226,nclc:2},{min:181,nclc:1}],speaking:[{min:450,nclc:10},{min:437,nclc:9},{min:415,nclc:8},{min:393,nclc:7},{min:371,nclc:6},{min:349,nclc:5},{min:310,nclc:4},{min:271,nclc:3},{min:226,nclc:2},{min:181,nclc:1}]};function Ae(e,t){const n=Ee[e];if(!n)return 0;for(const i of n)if(t>=i.min)return i.nclc;return 0}const Ne={listening:[{min:610,nclc:10},{min:590,nclc:9},{min:570,nclc:8},{min:549,nclc:7},{min:523,nclc:6},{min:503,nclc:5},{min:453,nclc:4},{min:398,nclc:3},{min:369,nclc:2},{min:331,nclc:1}],reading:[{min:625,nclc:10},{min:600,nclc:9},{min:575,nclc:8},{min:549,nclc:7},{min:524,nclc:6},{min:499,nclc:5},{min:453,nclc:4},{min:406,nclc:3},{min:375,nclc:2},{min:342,nclc:1}],writing:[{min:20,nclc:10},{min:19,nclc:9},{min:18,nclc:8},{min:16,nclc:7},{min:14,nclc:6},{min:12,nclc:5},{min:10,nclc:4},{min:7,nclc:3},{min:6,nclc:2},{min:4,nclc:1}],speaking:[{min:20,nclc:10},{min:19,nclc:9},{min:18,nclc:8},{min:16,nclc:7},{min:14,nclc:6},{min:12,nclc:5},{min:10,nclc:4},{min:7,nclc:3},{min:6,nclc:2},{min:4,nclc:1}]};function Oe(e,t){const n=Ne[e];if(!n)return 0;for(const i of n)if(t>=i.min)return i.nclc;return 0}const ie="crs-policy-ruleset-override-v1",Be=Object.freeze({"ircc-2025-03-25-v1":"ircc-2025-03-25-v2"});function R(e){const t=new Date(e);return Number.isNaN(t.getTime())?null:t}const O=[{id:"ircc-2024-01-01-v1",label:"Legacy arranged-employment points",effectiveDate:"2024-01-01",arrangedEmploymentPoints:!0,notes:["Legacy profile includes arranged-employment CRS additional points (NOC 00: +200, others: +50).","PNP nomination remains +600 additional points.","French additional points depend on both French and English thresholds."]},{id:"ircc-2025-03-25-v2",label:"Arranged-employment points removed",effectiveDate:"2025-03-25",arrangedEmploymentPoints:!1,notes:["Arranged-employment CRS additional points removed effective March 25, 2025.","PNP nomination remains +600 additional points.","French additional points depend on both French and English thresholds."]}].sort((e,t)=>{const n=R(e.effectiveDate)?.getTime()||0,i=R(t.effectiveDate)?.getTime()||0;return n-i});function oe(){return O[O.length-1]}function ae(e){const t=re(e);return O.find(n=>n.id===t)||null}function re(e){const t=String(e||"").trim();return t?Be[t]||t:""}function Ge(){if(typeof window>"u")return null;try{const e=window.localStorage.getItem(ie);if(!e)return null;const t=re(e),n=ae(t)?.id||null;return n?(String(e).trim()!==n&&window.localStorage.setItem(ie,n),n):null}catch{return null}}function Re(e=new Date){const t=R(e)||new Date;let n=O[0];for(const i of O){const o=R(i.effectiveDate);o&&o.getTime()<=t.getTime()&&(n=i)}return n||oe()}function He({asOfDate:e=new Date,ignoreOverride:t=!1}={}){if(!t){const i=Ge();if(i){const o=ae(i);if(o)return{...o,source:"override"}}}return{...Re(e),source:"effective_date"}}function je(e){const t={...De};return e?.arrangedEmploymentPoints?(t.job_offer_00=200,t.job_offer_other=50):(t.job_offer_00=0,t.job_offer_other=0),t}function ce({asOfDate:e=new Date,ignoreOverride:t=!1}={}){const n=He({asOfDate:e,ignoreOverride:t});return{version:n.id,label:n.label,source:n.source,effectiveDate:n.effectiveDate,notes:n.notes,tables:{agePoints:be,educationPoints:ke,firstLangPoints:we,secondLangPoints:Se,canadianWorkPoints:Ce,spouseEducationPoints:ve,spouseLangPoints:Me,spouseWorkPoints:xe,eduRank:_e,eduLangTransfer:Te,eduCWETransfer:Fe,fweLangTransfer:Ie,fweCWETransfer:$e,certLangTransfer:We,additionalPointsTable:je(n)},converters:{ieltsToCLB:Le,tefToNCLC:Ae,tcfToNCLC:Oe},caps:{secondLanguageNoSpouse:24,secondLanguageWithSpouse:22,spouseTotal:40,skillTransferabilityTotal:100,additionalPointsTotal:600,crsTotal:1200}}}const se=oe();se.id,se.effectiveDate,ce({ignoreOverride:!0});const le=(e,t,n)=>Math.max(t,Math.min(n,e)),W=()=>ce();function ze(e,t=W()){const n={...e},i=H(e)==="french"||e.hasFrench==="yes";if(i&&e.frenchTestType==="tef")for(const o of["listening","reading","writing","speaking"])n[`french_${o}`]=String(t.converters.tefToNCLC(o,parseInt(e[`tef_${o}`],10)||0));else if(i&&e.frenchTestType==="tcf")for(const o of["listening","reading","writing","speaking"])n[`french_${o}`]=String(t.converters.tcfToNCLC(o,parseInt(e[`tcf_${o}`],10)||0));return n}function H(e){return e.firstOfficialLanguage==="french"?"french":"english"}function q(e){return H(e)==="french"||e.hasFrench==="yes"}function Y(e){return e.hasSpouse==="yes"&&e.spouseIsCanadian!=="yes"&&e.spouseAccompanying!=="no"}const B=e=>Y(e)?1:0;function K(e,t,n=W()){if(e.langTestType==="celpip")return le(parseInt(e[`celpip_${t}`],10)||0,0,12);const i=parseFloat(e[`ielts_${t}`])||0;return n.converters.ieltsToCLB(t,i)}function V(e,t){return le(parseInt(e[`french_${t}`],10)||0,0,12)}function de(e,t,n=W()){return H(e)==="french"?V(e,t):K(e,t,n)}function Z(e,t=W()){const n=["listening","reading","writing","speaking"];let i=99;for(const o of n){const a=de(e,o,t);a<i&&(i=a)}return i===99?0:i}function Ue(e,t=W()){const n=["listening","reading","writing","speaking"];let i=99;for(const o of n){const a=K(e,o,t);a<i&&(i=a)}return i===99?0:i}function qe(e){if(!q(e))return 0;const t=["listening","reading","writing","speaking"];let n=99;for(const i of t){const o=V(e,i);o<n&&(n=o)}return n===99?0:n}function Ye(e,t){const n=Z(e,t);return n>=9?2:n>=7?1:0}function Ke(e){const t=parseInt(e.canadianWorkExp,10)||0;return t>=2?2:t>=1?1:0}function Ve(e){const t=parseInt(e.foreignWorkExp,10)||0;return t>=3?2:t>=1?1:0}function Ze(e,t){let n=parseInt(e.age,10);return Number.isNaN(n)?0:(n<18&&(n=17),n>47&&(n=47),n>44&&(n=45),t.tables.agePoints[n]?.[B(e)]||0)}function Je(e,t){return t.tables.educationPoints[e.education]?.[B(e)]||0}function Qe(e,t){const n=["listening","reading","writing","speaking"],i=B(e);return n.reduce((o,a)=>{const r=de(e,a,t);return o+(t.tables.firstLangPoints[r]?.[i]||0)},0)}function Xe(e,t){const n=H(e);if(!(n==="french"?e.langTestType==="ielts"||e.langTestType==="celpip":q(e)))return 0;const o=["listening","reading","writing","speaking"],a=B(e),r=o.reduce((c,s)=>{const d=n==="french"?K(e,s,t):V(e,s);return c+(t.tables.secondLangPoints[d]?.[a]||0)},0);return Math.min(r,a===0?t.caps.secondLanguageNoSpouse:t.caps.secondLanguageWithSpouse)}function et(e,t){let n=parseInt(e.canadianWorkExp,10)||0;return n>5&&(n=5),t.tables.canadianWorkPoints[n]?.[B(e)]||0}function tt(e,t){if(!Y(e))return 0;let n=0;n+=t.tables.spouseEducationPoints[e.spouseEducation]||0;const i=["listening","reading","writing","speaking"];let o=0;for(const r of i){const c=parseInt(e[`spouseLang_${r}`],10)||0;o+=t.tables.spouseLangPoints[c]||0}n+=Math.min(o,20);let a=parseInt(e.spouseCanadianWork,10)||0;return a>5&&(a=5),n+=t.tables.spouseWorkPoints[a]||0,Math.min(n,t.caps.spouseTotal)}function nt(e,t){const n=t.tables.eduRank[e.education]||0,i=Ye(e,t),o=Ke(e),a=Ve(e),r=t.tables.eduLangTransfer[n]?.[i]||0,c=t.tables.eduCWETransfer[n]?.[o]||0,s=Math.min(r+c,50),d=t.tables.fweLangTransfer[a]?.[i]||0,m=t.tables.fweCWETransfer[a]?.[o]||0,f=Math.min(d+m,50);let p=0;if(e.pathway==="fst"&&e.hasCertificate==="yes"){const u=Z(e,t);p=t.tables.certLangTransfer[u>=7?2:u>=5?1:0]}return Math.min(s+f+p,t.caps.skillTransferabilityTotal)}function it(e,t){let n=0;const i=t.tables.additionalPointsTable;return e.hasPNP==="yes"&&(n+=i.pnp_nomination),e.hasJobOffer==="yes"&&(n+=e.jobOfferTeer==="teer_0"?i.job_offer_00:i.job_offer_other),e.canadianEducation==="yes"&&(n+=e.canadianEduType==="long"?i.canadian_edu_long:i.canadian_edu_short),e.hasSibling==="yes"&&(n+=i.sibling_in_canada),q(e)&&qe(e)>=7&&(n+=Ue(e,t)>=5?i.french_strong_strong_english:i.french_strong_weak_english),Math.min(n,t.caps.additionalPointsTotal)}function ot(e){const t=W(),n=ze(e,t),i=Ze(n,t),o=Je(n,t),a=Qe(n,t),r=Xe(n,t),c=et(n,t),s=parseInt(n.foreignWorkExp,10)||0,d=i+o+a+r+c,m=tt(n,t),f=nt(n,t),p=it(n,t);return{total:Math.min(d+m+f+p,t.caps.crsTotal),breakdown:{coreHumanCapital:d,spouseFactors:m,skillTransferability:f,additionalPoints:p},details:{age:i,education:o,firstLanguage:a,secondLanguage:r,canadianWork:c,foreignWork:s,spouseTotal:m,skillTotal:f,additionalTotal:p},policy:{version:t.version,effectiveDate:t.effectiveDate,source:t.source}}}function at(e,t){return ot({...e,...t})}const J=["less_than_secondary","secondary","one_year_post","two_year_post","bachelors","two_or_more","masters","doctoral"],rt={Easy:14,Medium:7,Hard:0},ue={high:78,medium:58,low:35};function Q(e,t,n){return Math.max(t,Math.min(n,e))}function ct(e,t=ne.averageCutoff){return Math.max(t+10,e+25)}function st(e,t){return{listening:{7:6,8:7.5,9:8,10:8.5},reading:{7:6,8:6.5,9:7,10:8},writing:{7:6,8:6.5,9:7,10:7.5},speaking:{7:6,8:6.5,9:7,10:7.5}}[e]?.[t]||0}function lt(e,t){if(e.firstOfficialLanguage==="french"){const i=["listening","reading","writing","speaking"],o={hasFrench:"yes",frenchTestType:"clb"};for(const a of i){const r=`french_${a}`;o[r]=String(Math.max(parseInt(e[r],10)||0,t))}return o}const n=["listening","reading","writing","speaking"];if(e.langTestType==="celpip"){const i={};for(const o of n){const a=`celpip_${o}`;i[a]=String(Math.max(parseInt(e[a],10)||0,t))}return i}if(e.langTestType==="ielts"){const i={};for(const o of n){const a=`ielts_${o}`,r=st(o,t);i[a]=String(Math.max(parseFloat(e[a])||0,r))}return i}return{langTestType:"celpip",celpip_listening:String(t),celpip_reading:String(t),celpip_writing:String(t),celpip_speaking:String(t)}}function dt(e,t=7){const n={listening:parseInt(e.french_listening,10)||0,reading:parseInt(e.french_reading,10)||0,writing:parseInt(e.french_writing,10)||0,speaking:parseInt(e.french_speaking,10)||0};return{hasFrench:"yes",frenchTestType:"clb",french_listening:String(Math.max(n.listening,t)),french_reading:String(Math.max(n.reading,t)),french_writing:String(Math.max(n.writing,t)),french_speaking:String(Math.max(n.speaking,t))}}function ut({pathId:e,gain:t,months:n,steps:i}){return i.map((o,a)=>({id:`${e}-m${a+1}`,title:o.title,details:o.details,etaWeeks:o.etaWeeks,expectedGain:a===i.length-1?Math.max(t-i.slice(0,-1).reduce((r,c)=>r+c.expectedGain,0),0):o.expectedGain,done:!1,monthHint:Q(Math.ceil((o.etaWeeks||1)/4),1,n)}))}function fe({gain:e,months:t,difficulty:n,goalReached:i,likelihood:o}){const a=Q(24-t*2,0,24),r=Q(Math.round(e/4),0,80),c=i?32:0,s=Math.round((ue[o]||0)/3);return r+a+c+s+(rt[n]||0)}function D({id:e,title:t,summary:n,category:i,difficulty:o,months:a,estimatedCostCad:r,whyItFits:c,likelihood:s="medium",overrides:d,currentScore:m,targetScore:f,milestoneSteps:p}){const u=at(d.baseAnswers,d.patch),y=u.total-m;if(y<=0)return null;const C=u.total>=f,k=ut({pathId:e,gain:y,months:a,steps:p});return{id:e,title:t,summary:n,category:i,difficulty:o,estimatedMonths:a,estimatedCostCad:r,projectedScore:u.total,potentialGain:y,goalReached:C,whyItFits:c,likelihood:s,likelihoodPercent:ue[s]||50,fitScore:fe({gain:y,months:a,difficulty:o,goalReached:C,likelihood:s}),milestones:k,checks:{targetScore:f,currentScore:m,stillNeededAfterPath:Math.max(f-u.total,0)}}}function ft(e,t,n){const i=Z(e);if(i>=10)return null;const o=i<7?8:9,a=e.firstOfficialLanguage==="french"?"french":"english",r=a==="french"?"French Accelerator Path":"English Accelerator Path",c=a==="french"?"Raise your weakest French ability first, then target NCLC 9+ for stronger transferability outcomes.":"Raise your weakest English ability first, then target CLB 9+ for transferability gains.";return D({id:`${a}-accelerator`,title:r,summary:c,category:"Language",difficulty:"Medium",months:4,estimatedCostCad:460,whyItFits:`Your current minimum first-official-language level is CLB/NCLC ${i}, so language gains are one of the fastest realistic boosters.`,likelihood:"high",overrides:{baseAnswers:e,patch:lt(e,o)},currentScore:t,targetScore:n,milestoneSteps:[{title:"Baseline audit and weak-skill diagnosis",details:"Run a mock test and identify the lowest 2 abilities to prioritize.",etaWeeks:1,expectedGain:0},{title:"Targeted study sprint",details:"Follow a 5-day weekly schedule focused on weakest modules and timed drills.",etaWeeks:6,expectedGain:8},{title:"Exam booking + strategy correction",details:"Book IELTS/CELPIP and fine-tune pacing, vocabulary, and response format.",etaWeeks:4,expectedGain:8},{title:"Retake and profile refresh",details:"Update final language scores in your profile and reassess draw competitiveness.",etaWeeks:4,expectedGain:12}]})}function mt(e,t,n){return e.firstOfficialLanguage==="french"?null:D({id:"french-advantage",title:"French Advantage Path",summary:"Reach NCLC 7 in all French abilities to unlock additional points and French-category draw access.",category:"Language",difficulty:"Hard",months:8,estimatedCostCad:690,whyItFits:"French pathways remain one of the highest-yield options for many candidates below general cutoffs.",likelihood:e.hasFrench==="yes"?"high":"medium",overrides:{baseAnswers:e,patch:dt(e,7)},currentScore:t,targetScore:n,milestoneSteps:[{title:"French baseline + study plan",details:"Assess current level and choose a structured curriculum for NCLC 7 goal.",etaWeeks:2,expectedGain:0},{title:"Core skill build phase",details:"Intensive reading/listening practice with weekly speaking/writing correction.",etaWeeks:12,expectedGain:8},{title:"TEF/TCF prep and mock cycles",details:"Complete timed mocks and focus weak modules before exam booking.",etaWeeks:8,expectedGain:8},{title:"Exam and score integration",details:"Enter verified NCLC scores and evaluate French-category competitiveness.",etaWeeks:6,expectedGain:12}]})}function pt(e,t,n){const i=parseInt(e.canadianWorkExp,10)||0;return i>=5?null:D({id:"canadian-work-ladder",title:"Canadian Work Ladder Path",summary:"Add one more year of Canadian skilled work to increase core and transferability points.",category:"Work Experience",difficulty:"Hard",months:12,estimatedCostCad:0,whyItFits:`You currently report ${i} year(s) of Canadian work; the next year can materially lift your score.`,likelihood:"medium",overrides:{baseAnswers:e,patch:{canadianWorkExp:String(i+1)}},currentScore:t,targetScore:n,milestoneSteps:[{title:"Employer alignment",details:"Confirm TEER eligibility and maintain full-time skilled role continuity.",etaWeeks:2,expectedGain:0},{title:"Documentation discipline",details:"Collect monthly pay records and letters for future proof of experience.",etaWeeks:16,expectedGain:4},{title:"Mid-year score checkpoint",details:"Recalculate progress and combine with language upgrades if needed.",etaWeeks:24,expectedGain:6},{title:"Complete one full year increment",details:"Update profile immediately when additional year is met.",etaWeeks:52,expectedGain:12}]})}function gt(e,t,n){const i=J.indexOf(e.education);if(i<0||i>=J.length-1)return null;const o=J[i+1];return D({id:"education-upgrade",title:"Education Upgrade Path",summary:"Move to the next recognized credential tier for predictable CRS uplift.",category:"Education",difficulty:"Hard",months:18,estimatedCostCad:12e3,whyItFits:`Your current education level can be improved to ${o.replace(/_/g," ")} for additional points.`,likelihood:"medium",overrides:{baseAnswers:e,patch:{education:o}},currentScore:t,targetScore:n,milestoneSteps:[{title:"Program selection",details:"Choose an accredited credential path aligned to CRS point tiers.",etaWeeks:4,expectedGain:0},{title:"Enrollment and milestone completion",details:"Track term-level progress to keep the plan on schedule.",etaWeeks:20,expectedGain:4},{title:"Credential completion prep",details:"Prepare final documents and ECA requirements where needed.",etaWeeks:20,expectedGain:4},{title:"Credential update in profile",details:"Add completed credential and recalculate total score immediately.",etaWeeks:28,expectedGain:10}]})}function ht(e,t,n){if(!Y(e))return null;const i=["listening","reading","writing","speaking"],o={};for(const a of i){const r=`spouseLang_${a}`;o[r]=String(Math.max(parseInt(e[r],10)||0,9))}return D({id:"spouse-optimization",title:"Spouse Optimization Path",summary:"Use spouse language and experience factors for faster low-cost point improvements.",category:"Family Factors",difficulty:"Medium",months:5,estimatedCostCad:420,whyItFits:"You have an accompanying spouse, so spouse-factor optimization is available and often underused.",likelihood:"high",overrides:{baseAnswers:e,patch:o},currentScore:t,targetScore:n,milestoneSteps:[{title:"Spouse baseline review",details:"Identify spouse factors currently missing points.",etaWeeks:1,expectedGain:0},{title:"Spouse language prep",details:"Prepare specifically for CLB 9 in the weakest spouse abilities.",etaWeeks:8,expectedGain:4},{title:"Spouse profile integration",details:"Update spouse test scores and re-optimize joint profile configuration.",etaWeeks:6,expectedGain:8}]})}function yt(e,t,n){return e.hasPNP==="yes"?null:D({id:"pnp-fast-track",title:"PNP Fast-Track Path",summary:"Pursue provincial nomination for the largest single CRS jump (+600).",category:"Provincial",difficulty:"Hard",months:6,estimatedCostCad:2200,whyItFits:"If your baseline is below recent cutoffs, PNP remains the most direct guaranteed-lift route.",likelihood:"medium",overrides:{baseAnswers:e,patch:{hasPNP:"yes"}},currentScore:t,targetScore:n,milestoneSteps:[{title:"Province shortlist",details:"Match your profile to provinces aligned with occupation/language strengths.",etaWeeks:2,expectedGain:0},{title:"Document stack preparation",details:"Prepare references, test proofs, ECA, and provincial forms early.",etaWeeks:6,expectedGain:0},{title:"Submit nomination stream",details:"Apply to selected stream and monitor NOI/application updates.",etaWeeks:8,expectedGain:0},{title:"Nomination linked to profile",details:"Accept nomination and refresh profile for major score jump.",etaWeeks:8,expectedGain:600}]})}function bt(e,t){const n=[...e].sort((s,d)=>d.fitScore-s.fitScore);if(n.length<2)return null;const[i,o]=n,a=Math.min(i.projectedScore+o.potentialGain,1200),r=a-i.checks.currentScore;if(r<=0)return null;const c=a>=t;return{id:"combo-bridge-plan",title:"Bridge Combination Path",summary:`Combine “${i.title}” + “${o.title}” to maximize speed while limiting risk.`,category:"Combination",difficulty:i.difficulty==="Hard"||o.difficulty==="Hard"?"Hard":"Medium",estimatedMonths:Math.round((i.estimatedMonths+o.estimatedMonths)/2),estimatedCostCad:i.estimatedCostCad+o.estimatedCostCad,projectedScore:a,potentialGain:r,goalReached:c,whyItFits:"A blended route often reaches target faster than single-track attempts.",likelihood:"medium",likelihoodPercent:62,fitScore:fe({gain:r,months:Math.round((i.estimatedMonths+o.estimatedMonths)/2),difficulty:i.difficulty==="Hard"||o.difficulty==="Hard"?"Hard":"Medium",goalReached:c,likelihood:"medium"}),milestones:[...i.milestones.slice(0,2).map(s=>({...s,id:`combo-${s.id}`})),...o.milestones.slice(0,2).map(s=>({...s,id:`combo-${s.id}`})),{id:"combo-final-sync",title:"Final score synchronization",details:"Update all achieved improvements together and reassess draw strategy.",etaWeeks:4,expectedGain:Math.max(r-16,0),done:!1,monthHint:2}],checks:{targetScore:t,currentScore:i.checks.currentScore,stillNeededAfterPath:Math.max(t-a,0)}}}function kt(e,t,n={}){const i=t?.total||0,o=Number(n.averageCutoff)||ne.averageCutoff,a=Number(n.targetScore)||ct(i,o),r=[ft(e,i,a),mt(e,i,a),pt(e,i,a),gt(e,i,a),ht(e,i,a),yt(e,i,a)].filter(Boolean),c=bt(r,a);c&&r.push(c);const s=r.sort((d,m)=>m.fitScore-d.fitScore).slice(0,5);return{currentScore:i,targetScore:a,plans:s,generatedAt:new Date().toISOString()}}const me=1440*60*1e3,pe={High:3,Medium:2,Low:1},x={impact:.34,speed:.18,confidence:.22,effort:.12,laneFit:.14},E={budgetCad:3500,weeklyHours:6,examAttempts:2,relocationPreference:"balanced"},wt=[{id:"3m",label:"3 months",months:3,gainFactor:.35},{id:"6m",label:"6 months",months:6,gainFactor:.62},{id:"12m",label:"12 months",months:12,gainFactor:.88}];function h(e,t,n){return Math.max(t,Math.min(n,e))}function St(e,t){return`Day ${e}-${t}`}function l(e,t=0){const n=Number(e);return Number.isFinite(n)?n:t}function _(e,t=0){const n=parseInt(e,10);return Number.isFinite(n)?n:t}function ge(e={}){const t=e&&typeof e=="object"?e:{},n=["balanced","province","federal"].includes(t.relocationPreference)?t.relocationPreference:E.relocationPreference;return{budgetCad:h(_(t.budgetCad,E.budgetCad),500,2e4),weeklyHours:h(_(t.weeklyHours,E.weeklyHours),2,30),examAttempts:h(_(t.examAttempts,E.examAttempts),1,8),relocationPreference:n}}function Ct(e=new Date){const t=new Date(e);return t.setHours(0,0,0,0),t}function j(e,t){return new Date(e.getTime()+t*me)}function X(e){try{return e.toLocaleDateString(void 0,{month:"short",day:"numeric"})}catch{return e.toISOString().slice(0,10)}}function z(e,t,n){const i=j(e,Math.max(t-1,0)),o=j(e,Math.max(n-1,0));return{startDateIso:i.toISOString(),endDateIso:o.toISOString(),weekWindow:`Week ${Math.ceil(t/7)}-${Math.ceil(n/7)}`,dateWindow:`${X(i)} → ${X(o)}`}}function vt(e,t){const n=l(t);return e==="listening"?n>=8.5?10:n>=8?9:n>=7.5?8:n>=6?7:n>=5.5?6:n>=5?5:0:e==="reading"?n>=8?10:n>=7?9:n>=6.5?8:n>=6?7:n>=5?6:n>=4?5:0:n>=7.5?10:n>=7?9:n>=6.5?8:n>=6?7:n>=5.5?6:n>=5?5:0}function Mt(e={}){const t=["listening","reading","writing","speaking"],n=e.firstOfficialLanguage==="french",o=t.map(a=>n?_(e[`french_${a}`],0):e.langTestType==="celpip"?_(e[`celpip_${a}`],0):vt(a,e[`ielts_${a}`])).filter(a=>a>0);return o.length?Math.min(...o):0}function P(e,t,n,i="medium"){return{id:e,label:t,detail:n,severity:i}}function xt(e){return e==="high"?10:e==="medium"?5:2}function Pt(e="Medium"){return e==="Easy"?100:e==="Medium"?68:38}function Lt(e=0){return e>=76?"High":e>=56?"Medium":"Low"}function _t(e={},t,n){const i=l(t?.total),o=n-i,a=_(e.age,0),r=Mt(e),c=e.hasFrench==="yes"||e.firstOfficialLanguage==="french",s=_(e.canadianWorkExp,0),d=_(e.foreignWorkExp,0),m=r>=9?18:r>=7?46:74,f=h((a>=33?28:14)+(r<7?26:r<9?16:6)+(s===0?12:4)+(d>=3?8:3),10,90),p=[{key:"answers_accuracy",label:"Profile values are accurate and complete",confidence:e.knowsScore==="yes"?"Medium":"High"},{key:"draw_trend_stability",label:"Recent draw patterns remain directionally similar",confidence:Math.abs(o)<=20?"Medium":"Low"},{key:"execution_discipline",label:"You can sustain weekly execution cadence for 90 days",confidence:f<=45?"High":f<=65?"Medium":"Low"}],u=[];return a>=33&&u.push(P("risk-age-decay","Age-point decay risk","Delays can reduce score as age thresholds change.",a>=38?"high":"medium")),r>0&&r<7&&u.push(P("risk-language-floor","Language floor below CLB 7","Several lanes become weaker or inaccessible below CLB 7.","high")),c||u.push(P("risk-no-french","No French upside yet","You may miss lower-cutoff category opportunities tied to French strength.","low")),o>40&&u.push(P("risk-large-gap","Large score gap","A single action may not close this gap; a combination strategy is likely required.","high")),{score:i,gap:o,age:a,minLanguageClb:r,hasFrench:c,canadianWorkExp:s,foreignWorkExp:d,languageHeadroom:m,profileComplexity:f,assumptions:p,globalRiskFlags:u}}function Tt(e={}){const t=[e.age,e.education,e.pathway,e.canadianWorkExp,e.foreignWorkExp,e.hasFrench,e.hasPNP].join("|");let n=0;for(let i=0;i<t.length;i+=1)n=(n<<5)-n+t.charCodeAt(i),n|=0;return Math.abs(n).toString(16)}function Ft(e,t,n){const i=e.category==="Language"?50+t.languageHeadroom*.45:e.category==="Provincial"?72:e.category==="Combination"?76:60,o=h(i+(e.goalReached?8:0)+(e.likelihoodPercent-50)*.35,30,95),a=[];return e.estimatedMonths>=10&&a.push(P(`${e.id}-timeline`,"Long timeline","This lane can take substantial time before score impact materializes.","medium")),e.difficulty==="Hard"&&a.push(P(`${e.id}-effort`,"Execution intensity","Consistent weekly effort is required to avoid plan drift.","medium")),!e.goalReached&&n>0&&a.push(P(`${e.id}-bridge`,"May require a second lane","This lane may need a backup action to fully close your gap.","low")),{id:`path-${e.id}`,title:e.title,lane:e.category,reason:e.whyItFits,scoreGain:e.potentialGain,months:e.estimatedMonths,confidence:e.likelihoodPercent,effort:e.difficulty,estimatedCostCad:l(e.estimatedCostCad,0),examSensitive:e.category==="Language"||/language|ielts|celpip|tef|tcf|french/i.test(e.title||""),laneFit:o,riskFlags:a}}function It({score:e,cutoff:t,eligibleCount:n,signals:i}){const o=t-e,a=o<=0?82:o<=20?64:38,r=[];return n||r.push(P("category-not-eligible","Not category-eligible yet","A prerequisite profile change is required before this lane can be used.","high")),o>35&&r.push(P("category-gap","Gap still material","Category targeting helps, but the score gap remains significant.","medium")),{id:"lane-category-draws",title:"Category Draw Positioning",lane:"Category Draws",reason:n>0?`You match ${n} category stream(s). Improve targeted factors to close the category cutoff gap.`:"You are not currently category-eligible; targeted profile adjustments can unlock lower-cutoff streams.",scoreGain:h(Math.round(Math.max(o,0)*.5),0,80),months:o<=0?1:o<=20?4:8,confidence:a,effort:o<=0?"Easy":o<=20?"Medium":"Hard",estimatedCostCad:1200,examSensitive:!i.hasFrench,laneFit:h((n>0?70:35)+(i.hasFrench?8:0),25,90),riskFlags:r}}function $t(e){if(!e)return null;const t=[];return e.matchScore<55&&t.push(P(`province-${e.id}-fit`,"Lower province fit","Province alignment is currently moderate; stream targeting needs tighter matching.","high")),e.matchScore>=55&&e.matchScore<70&&t.push(P(`province-${e.id}-variance`,"Selection variance","Provincial intake criteria can shift and may require profile tuning.","medium")),{id:`lane-province-${e.id}`,title:`${e.name} PNP Focus`,lane:"Provincial",reason:`${e.name} has the highest profile match in your province analysis.`,scoreGain:e.matchScore>=70?600:300,months:e.matchScore>=70?6:9,confidence:h(e.matchScore,35,88),effort:e.matchScore>=70?"Medium":"Hard",estimatedCostCad:e.matchScore>=70?3200:4200,examSensitive:!1,laneFit:h(e.matchScore+(e.matchScore>=70?6:-4),25,95),riskFlags:t}}function Wt(e={},t=0){return[{key:"coreHumanCapital",label:"Core profile factors",value:l(e.coreHumanCapital)},{key:"skillTransferability",label:"Transferability factors",value:l(e.skillTransferability)},{key:"additionalPoints",label:"Additional point factors",value:l(e.additionalPoints)},{key:"spouseFactors",label:"Spouse factors",value:l(e.spouseFactors)}].map(i=>({...i,headroom:h(100-Math.round(i.value/Math.max(t,1)*100),0,100)})).sort((i,o)=>o.headroom-i.headroom).slice(0,2)}function Dt(e,t){const n=Math.max(Math.abs(t),35),i=h(Math.round(e.scoreGain/n*100),8,100),o=h(100-e.months*11,12,100),a=h(e.confidence,12,100),r=Pt(e.effort),c=h(l(e.laneFit,60),10,100),s=i*x.impact+o*x.speed+a*x.confidence+r*x.effort+c*x.laneFit,d=Array.isArray(e.riskFlags)?e.riskFlags:[],m=h(d.reduce((p,u)=>p+xt(u.severity),0),0,24),f=h(Math.round(s-m),1,100);return{...e,score:f,riskPenalty:m,scoreBreakdown:[{key:"impact",label:"Impact potential",value:i,weight:x.impact},{key:"speed",label:"Speed to value",value:o,weight:x.speed},{key:"confidence",label:"Data confidence",value:a,weight:x.confidence},{key:"effort",label:"Execution ease",value:r,weight:x.effort},{key:"laneFit",label:"Profile-lane fit",value:c,weight:x.laneFit}]}}function Et(e={}){const t=e.effort==="Hard"?10:e.effort==="Medium"?6:3,n=l(e.months,6)<=3?2:l(e.months,6)<=6?1:0;return t+n}function At(e={}){const t=l(e.estimatedCostCad,0);return t>0?t:e.lane==="Provincial"?3600:e.lane==="Category Draws"?1200:e.lane==="Language"?1800:2200}function Nt(e={}){return/provincial/i.test(e.lane||"")}function Ot(e,t){const n=ge(t),i=[],o=At(e),a=Et(e);let r=0;const c=n.budgetCad/Math.max(o,1);if(c<.75){const u=Math.min(Math.round((.75-c)*20),12);r-=u,i.push({id:"budget",label:"Budget pressure",delta:-u})}else if(c>1.35){const u=Math.min(Math.round((c-1.35)*8),5);r+=u,i.push({id:"budget",label:"Budget headroom",delta:u})}const s=n.weeklyHours-a;if(s<0){const u=Math.min(Math.abs(s)*2,10);r-=u,i.push({id:"time",label:"Time constraint",delta:-u})}else if(s>0){const u=Math.min(s,4);r+=u,i.push({id:"time",label:"Time capacity",delta:u})}if(e.examSensitive){if(n.examAttempts<=1)r-=8,i.push({id:"exam",label:"Low exam retry budget",delta:-8});else if(n.examAttempts>=3){const u=Math.min((n.examAttempts-2)*2,4);r+=u,i.push({id:"exam",label:"Exam retry flexibility",delta:u})}}const d=Nt(e);if(n.relocationPreference==="province"){const u=d?8:-3;r+=u,i.push({id:"relocation",label:"Province-focused preference",delta:u})}else if(n.relocationPreference==="federal"){const u=d?-7:4;r+=u,i.push({id:"relocation",label:"Federal-focused preference",delta:u})}const m=h(Math.round(r),-24,18),f=h(e.score+m,1,100),p=h(Math.round(70+m*2),12,99);return{...e,baseScore:e.score,score:f,constraintAdjustment:m,constraintFitScore:p,constraintFactors:i,estimatedCostCad:o,requiredWeeklyHours:a}}function Bt(e){const t=new Date(e?.date||"");return Number.isNaN(t.getTime())?null:t}function Gt(e={},t=10){return[...e.generalProgram||[],...e.categoryBased||[],...e.pnpDraws||[]].map(i=>({score:l(i?.score),date:Bt(i),program:i?.program||"Unknown"})).filter(i=>i.score>0&&i.date).sort((i,o)=>o.date.getTime()-i.date.getTime()).slice(0,t)}function Rt(e=[]){if(!e.length)return 0;const t=e.reduce((i,o)=>i+o,0)/e.length,n=e.reduce((i,o)=>i+(o-t)**2,0)/e.length;return Math.sqrt(n)}function he(e=0){return e>=75?"High":e>=55?"Medium":"Low"}function ee({scoreGap:e=0,volatility:t=0,confidence:n=60}){const i=h((e+80)/160,0,1),o=h(l(t)/120,0,.26),a=h(l(n,60)/100,0,1)*.2,r=i*.72+a-o;return h(r,.02,.98)}function Ht({forecast:e,averageCutoff:t,horizonMonths:n}){if(!e)return Math.round(l(t,520));const i=l(e.projectedNextCutoff,l(t,520)),o=l(e.slopePerDraw,0),a=Math.max(Math.round(n/2),1);return Math.round(h(i+o*Math.max(a-1,0),300,800))}function jt(e=0){return e>=70?"High":e>=45?"Medium":"Low"}function zt({strategy:e,forecast:t,actionPlan:n,averageCutoff:i,userScore:o}){const a=l(o,l(e?.score,0)),r=Math.max(l(e?.top?.scoreGain,0),0),c=h(l(n?.completionPct,0),0,100),s=h(c/100*.55+.45,.4,1),d=l(t?.volatility,14),m=l(t?.confidenceScore,e?.overallConfidence||58),f=e?.top?.title||"Primary strategy lane",p=wt.map(b=>{const S=Ht({forecast:t,averageCutoff:i,horizonMonths:b.months}),v=Math.round(r*b.gainFactor*s),M=a+v,L=Math.round(M-S),F=ee({scoreGap:L,volatility:d,confidence:m}),I=ee({scoreGap:L+Math.max(Math.round(r*.35),8),volatility:d*.75,confidence:m+8}),G=ee({scoreGap:L-Math.max(Math.round(r*.45),10),volatility:d*1.25,confidence:m-10}),$=Math.round(F*100),U=Math.round(I*100),te=Math.round(G*100),w=h(Math.round(26+d*.8-m*.18),8,34),T=h(Math.round($-w/2),1,99),sn=h(Math.round($+w/2),1,99);return{id:b.id,label:b.label,months:b.months,projectedCutoff:S,expectedScore:M,expectedGain:v,scoreGap:L,baseProbabilityPct:$,bestProbabilityPct:U,worstProbabilityPct:te,chanceBand:jt($),confidenceInterval:{lowPct:T,highPct:sn,uncertaintyPct:w}}}),y=[...p].sort((b,S)=>S.baseProbabilityPct!==b.baseProbabilityPct?S.baseProbabilityPct-b.baseProbabilityPct:b.months-S.months)[0]||p[0]||null,C=y?.id||"6m",k=he(m),g=[{id:"top_lane_gain",label:`${f} expected gain`,value:`+${Math.round(r)} pts potential`,influence:r>=20?"positive":"neutral"},{id:"execution_cadence",label:"Execution cadence",value:`${c}% action-plan completion`,influence:c>=55?"positive":c>=25?"neutral":"negative"},{id:"draw_volatility",label:"Draw volatility pressure",value:`${Number(d).toFixed(2)} volatility`,influence:d<=12?"positive":d<=24?"neutral":"negative"}];return{generatedAt:new Date().toISOString(),confidenceBand:k,recommendedHorizonId:C,topLane:f,horizons:p,keyDrivers:g,summary:y?`Best current horizon: ${y.label} with ${y.baseProbabilityPct}% base invitation probability.`:"Digital twin is preparing probability projections."}}function Ut({activeDraws:e,userScore:t,baseConfidence:n=60}){const i=Gt(e,10);if(!i.length)return null;const o=i[0],a=[...i].reverse(),r=a[0],c=a[a.length-1],s=a.length,d=s>1?(c.score-r.score)/(s-1):0,m=o.score,f=Math.round(h(m+d,300,800)),p=Math.round(h(f+d,300,800)),u=Math.round(h(p+d,300,800)),y=Math.round((f+p+u)/3),C=Rt(i.map(F=>F.score)),k=o.date,g=k?Math.floor((Date.now()-k.getTime())/me):999;let b=l(n,60);b+=Math.min(s*3,18),b-=Math.min(C*1.2,24),g<=2?b+=5:g<=7?b+=1:g>14&&(b-=9),b=h(Math.round(b),20,92);const S=d>1.5?"rising":d<-1.5?"falling":"stable",v=S==="rising"?"Cutoff trend is rising":S==="falling"?"Cutoff trend is falling":"Cutoff trend is stable",M=l(t)-f,L=M>=20?"High":M>=0?"Medium":"Low";return{sampleSize:s,volatility:Number(C.toFixed(2)),slopePerDraw:Number(d.toFixed(2)),projectedNextCutoff:f,projectedThreeDrawAvg:y,projectedDraws:[f,p,u],trendDirection:S,trendLabel:v,confidenceScore:b,confidenceBand:he(b),invitationLikelihood:L,userGapToNext:M,latestObservedCutoff:m,latestObservedProgram:o.program,latestObservedDateIso:k?.toISOString()||""}}function qt({answers:e,result:t,averageCutoff:n,categoryInfo:i=[],provinces:o=[],eligibleCategoryCount:a=Number.NaN,optimizerConstraints:r=E}){const c=ge(r),s=l(t?.total),d=l(n,520),m=d-s,f=_t(e,t,d),u=(kt(e,t,{averageCutoff:d}).plans||[]).slice(0,2).map(w=>Ft(w,f,m)),y=l(a,Number.NaN),C=Number.isFinite(y)?Math.max(Math.round(y),0):i.filter(w=>typeof w?.check=="function"&&w.check(e)).length,k=It({score:s,cutoff:d,eligibleCount:C,signals:f}),g=$t((o||[])[0]||null),S=[...u,k,g].filter(Boolean).map(w=>Dt(w,m)).map(w=>Ot(w,c)).sort((w,T)=>T.score-w.score).slice(0,4),v=S[0]||null,M=S[1]||null,L=Wt(t?.breakdown,s),F=[...f.globalRiskFlags||[],...S.slice(0,2).flatMap(w=>w.riskFlags||[])],I=Object.values(F.reduce((w,T)=>(T?.id&&(w[T.id]||(w[T.id]=T)),w),{})).slice(0,5),G=S.slice(0,2).map(w=>h(w.confidence-w.riskPenalty,0,100)),$=G.length?Math.round(G.reduce((w,T)=>w+T,0)/G.length):36,U=Lt($),te=v?`Primary lane: ${v.title}. Estimated gain ${v.scoreGain} points in ~${v.months} months (${U.toLowerCase()} confidence).`:"No strong lane detected yet. Start by improving language and category eligibility.";return{score:s,cutoff:d,gap:m,ranked:S,top:v,nextBest:M,bottlenecks:L,assumptions:f.assumptions,globalRiskFlags:I,overallConfidence:$,confidenceBand:U,profileSignals:{minLanguageClb:f.minLanguageClb,profileComplexity:f.profileComplexity,languageHeadroom:f.languageHeadroom},optimizerConstraints:c,scoreWeights:x,guidanceSummary:te}}function ye(e="in_progress"){return e==="ready"?100:e==="blocked"?28:62}function Yt(e={}){const t=String(e.lane||"").toLowerCase();return t.includes("provincial")?"Shortlist province streams and prep EOI documents this week.":t.includes("category")?"Align profile to category thresholds and track next category rounds.":t.includes("language")?"Book exam slot and run a focused weekly language sprint.":"Execute the next milestone from your primary lane playbook."}function Kt(e={},t=0){const n=String(e.lane||"").toLowerCase();let i=n.includes("provincial")?45:n.includes("category")?21:28;const o=l(e.months,6);return o<=3&&(i-=6),o>=9&&(i+=10),t>35&&(i+=7),t<=5&&(i-=3),h(Math.round(i),10,90)}function Vt(e=0){return e<=14?"Next 2 weeks":e<=30?"Next 30 days":e<=60?"Next 1-2 months":"Next quarter"}function A(e=0){return e>=78?"High":e>=56?"Medium":"Low"}function Zt({strategy:e,forecast:t=null,averageCutoff:n=0,userScore:i=0,eligibleCategoryCount:o=0}){const a=Array.isArray(e?.ranked)?e.ranked:[],r=l(i,l(e?.score,0)),c=l(n,l(e?.cutoff,520)),s=Math.max(Math.round(c-r),0),d=l(t?.confidenceScore,l(e?.overallConfidence,58)),m=t?.trendDirection||"stable",f=a.slice(0,4).map((g,b)=>{const S=Kt(g,s),v=Math.max(c-(r+l(g.scoreGain,0)),0),M=h(100-Math.round(v*1.7),12,100),L=h(Math.round(l(g.score,0)*.54+l(g.constraintFitScore,60)*.18+d*.18+M*.1-l(g.riskPenalty,0)*.35),1,99),F=(g.riskFlags||[]).some(I=>I.severity==="high")?"high":(g.riskFlags||[]).some(I=>I.severity==="medium")?"medium":"low";return{id:`opportunity-${g.id||b}`,title:g.title,lane:g.lane,whyNow:g.reason,opportunityScore:L,confidenceBand:A(L),scoreDeltaNeeded:Math.round(v),windowDays:S,windowLabel:Vt(S),trendDirection:m,nextAction:Yt(g),riskLevel:F}}),p=o>0?[{id:"opportunity-category-eligibility",title:"Category-eligible window",lane:"Category Draws",whyNow:`You currently match ${o} category stream(s), which can create faster draw pathways.`,opportunityScore:h(58+o*6-Math.min(s,25),28,92),confidenceBand:o>=3?"High":"Medium",scoreDeltaNeeded:Math.max(s-12,0),windowDays:s<=15?18:28,windowLabel:s<=15?"Immediate window":"Next 30 days",trendDirection:m,nextAction:"Prioritize category-specific actions and monitor nearest category rounds.",riskLevel:s>30?"medium":"low"}]:[],u=[...f,...p].sort((g,b)=>b.opportunityScore-g.opportunityScore).slice(0,5),y=u[0]||null,C=u.length?Math.round(u.slice(0,3).reduce((g,b)=>g+b.opportunityScore,0)/Math.min(u.length,3)):0,k=u.slice(0,3).map(g=>({id:`trigger-${g.id}`,title:g.title,trigger:g.scoreDeltaNeeded<=0?"Activate immediately when next draw opens.":`Activate when remaining gap is ≤ ${Math.max(g.scoreDeltaNeeded-5,0)} points.`,windowLabel:g.windowLabel}));return{generatedAt:new Date().toISOString(),readinessIndex:C,recommendedOpportunityId:y?.id||"",recommendedWindow:y?.windowLabel||"No opportunity window detected",trendDirection:m,summary:y?`${y.title} is your best near-term opportunity (${y.opportunityScore}/100) in the ${y.windowLabel.toLowerCase()}.`:"Opportunity radar is waiting for additional profile signals.",signals:u,alertTriggers:k}}function Jt(e={}){const t=["age","education","pathway","canadianWorkExp","foreignWorkExp","langTestType"],n=t.filter(i=>{const o=e?.[i];return o==null?!1:typeof o=="string"?o.trim()!=="":!0}).length;return t.length>0?Math.round(n/t.length*100):0}function Qt({actionPlan:e,strategy:t,opportunityRadar:n,profileCompleteness:i,gap:o}){const a=Array.isArray(e?.tasks)?e.tasks:[],r=l(e?.completedCount,0)>0,c=!!t?.nextBest,s=Array.isArray(n?.signals)&&n.signals.length>0,d=i>=80?"ready":i>=55?"in_progress":"blocked",m=i>=85?"ready":i>=60?"in_progress":"blocked",f=c?"ready":o>20?"blocked":"in_progress",p=s?"ready":"in_progress";return[{id:"cmd-baseline",title:"Lock baseline profile + target score",owner:"Candidate",dueWindow:(a.find(y=>y.priority==="High")||a[0])?.dateWindow||"This week",status:r?"ready":d,evidence:r?"At least one high-priority plan task completed.":"Save baseline and confirm target delta."},{id:"cmd-primary-lane",title:`Execute primary lane: ${t?.top?.title||"Top strategy lane"}`,owner:"Candidate",dueWindow:t?.top?.months?`~${t.top.months} months`:"Next 30 days",status:r?"in_progress":"blocked",evidence:t?.top?.reason||"Primary lane rationale unavailable."},{id:"cmd-doc-pack",title:"Prepare application document command pack",owner:"Candidate + Consultant",dueWindow:"Days 30-60",status:m,evidence:`Profile completeness ${i}%.`},{id:"cmd-fallback",title:"Activate backup lane contingency",owner:"Consultant",dueWindow:"Before day 60",status:f,evidence:c?`Backup lane ready: ${t?.nextBest?.title}.`:"Backup lane not selected yet."},{id:"cmd-monitor",title:"Monitor upcoming draw windows and trigger rules",owner:"Candidate",dueWindow:n?.recommendedWindow,status:p,evidence:s?`${n?.signals?.length||0} opportunity signal(s) detected.`:"No radar opportunity signals detected yet."}]}function Xt({answers:e,result:t,strategy:n,actionPlan:i,opportunityRadar:o}){const a=l(t?.total,l(n?.score,0)),r=l(n?.cutoff,0),c=Math.max(r-a,0),s=Jt(e),d=Qt({actionPlan:i,strategy:n,opportunityRadar:o,profileCompleteness:s,gap:c}),m=[];c>35&&m.push({id:"blocker-gap",label:"Large score gap",detail:`Gap remains ${Math.round(c)} points.`}),(n?.profileSignals?.minLanguageClb||0)>0&&(n?.profileSignals?.minLanguageClb||0)<7&&m.push({id:"blocker-language-floor",label:"Language floor below CLB 7",detail:"Language score floor can limit lane viability."}),s<60&&m.push({id:"blocker-profile-completeness",label:"Profile completeness is low",detail:`Completeness is ${s}%; fill missing profile fields.`});const f=d.length?Math.round(d.reduce((u,y)=>u+ye(y.status),0)/d.length):0,p=h(Math.round(f*.45+l(i?.completionPct,0)*.35+l(n?.overallConfidence,0)*.2-Math.min(m.length*6,18)),0,100);return{generatedAt:new Date().toISOString(),readinessScore:p,readinessBand:A(p),blockers:m,profileCompleteness:s,checklist:d,summary:p>=75?"Application command center is in strong shape for near-term execution.":p>=55?"Application command center is progressing, with a few blockers to clear.":"Application command center needs foundational fixes before aggressive execution."}}function en({strategy:e,forecast:t,digitalTwin:n,commandCenter:i,opportunityRadar:o}){return[`Top lane: ${e?.top?.title||"N/A"} (${l(e?.top?.score,0)}/100)`,`Confidence: ${e?.confidenceBand||"Unknown"} (${l(e?.overallConfidence,0)}/100)`,`Forecast next cutoff: ${l(t?.projectedNextCutoff,l(e?.cutoff,0))}`,`Digital twin recommendation: ${(n?.recommendedHorizonId).toUpperCase?.()||"N/A"}`,`Command readiness: ${l(i?.readinessScore,0)}/100`,`Opportunity radar top window: ${o?.recommendedWindow}`]}function tn({strategy:e,forecast:t,actionPlan:n,digitalTwin:i,commandCenter:o,opportunityRadar:a}){const r=n?.nextBestTask,c=e?.top,s=a?.signals?.[0],d=en({strategy:e,forecast:t,digitalTwin:i,commandCenter:o,opportunityRadar:a}),m=[{id:"copilot-weekly-focus",prompt:"What should I execute this week?",response:r?`Execute "${r.title}" first, then continue "${c?.title||"your primary lane"}".`:`Prioritize "${c?.title||"your primary lane"}" this week and close one blocker.`,confidenceBand:A(l(e?.overallConfidence,0)),evidence:[d[0],`Next task: ${r?.title||"none"}`,`Action-plan completion: ${l(n?.completionPct,0)}%`],quickAction:"section-90-day-plan"},{id:"copilot-gap-clarity",prompt:"How close am I to the likely draw threshold?",response:`Your current gap is ${Math.round(Math.max(l(e?.gap,0),0))} points versus the average cutoff snapshot.`,confidenceBand:A(l(t?.confidenceScore,l(e?.overallConfidence,0))),evidence:[`Current score: ${l(e?.score,0)}`,`Cutoff reference: ${l(e?.cutoff,0)}`,`Forecast next cutoff: ${l(t?.projectedNextCutoff,l(e?.cutoff,0))}`],quickAction:"section-forecast"},{id:"copilot-opportunity-window",prompt:"Where is the fastest opportunity window?",response:s?`${s.title} is the top opportunity (${s.opportunityScore}/100) in the ${s.windowLabel.toLowerCase()}.`:"No high-confidence radar window yet; continue strengthening your top lane.",confidenceBand:s?.confidenceBand||"Low",evidence:[`Radar readiness index: ${l(a?.readinessIndex,0)}/100`,`Recommended window: ${a?.recommendedWindow}`,`Top lane fit: ${l(c?.constraintFitScore,0)}/100`],quickAction:"section-opportunity-radar"},{id:"copilot-risk-control",prompt:"What is my biggest execution risk right now?",response:o?.blockers?.[0]?`${o.blockers[0].label}. Address this before scaling to secondary lanes.`:"No major blockers detected. Keep execution cadence and monitor draw updates.",confidenceBand:A(l(o?.readinessScore,0)),evidence:[`Command readiness: ${l(o?.readinessScore,0)}/100`,`Blocker count: ${o?.blockers?.length||0}`,`Global risk flags: ${e?.globalRiskFlags?.length||0}`],quickAction:"section-command-center"}];return{generatedAt:new Date().toISOString(),modelLabel:"Grounded Strategy Copilot",groundingMode:"deterministic_rulepack_v1",cards:m,evidence:d}}function nn({answers:e,result:t,strategy:n,actionPlan:i,commandCenter:o,copilot:a}){const r=`ws-${Tt(e).slice(0,10)}`,c=[{id:"collab-policy",label:"Policy snapshot attached",status:t?.policy?.version?"ready":"blocked",detail:t?.policy?.version?`Using ${t.policy.version} (${t.policy.source||"unknown source"})`:"No policy snapshot found in result payload."},{id:"collab-lane",label:"Top lane rationale documented",status:n?.top?.reason?"ready":"in_progress",detail:n?.top?.reason||"Top lane rationale missing."},{id:"collab-action-plan",label:"Action milestones assigned",status:(i?.tasks?.length||0)>=3?"ready":"in_progress",detail:`${i?.tasks?.length||0} tasks available for consultant review.`},{id:"collab-copilot",label:"Grounded advisory briefs prepared",status:(a?.cards?.length||0)>=3?"ready":"in_progress",detail:`${a?.cards?.length||0} copilot brief(s) generated.`}],s=c.length?Math.round(c.reduce((f,p)=>f+ye(p.status),0)/c.length):0,d=h(Math.round(s*.5+l(o?.readinessScore,0)*.25+l(i?.completionPct,0)*.25),0,100),m=["Attach latest language test receipts and booking confirmations.","Highlight any province-specific ties or mobility constraints.","Confirm which lane is fallback if primary timeline slips by >20%."];return{generatedAt:new Date().toISOString(),workspaceId:r,workspaceReadiness:d,readinessBand:A(d),packageStatus:d>=72?"review_ready":d>=52?"needs_follow_up":"draft",reviewChecklist:c,collaborationNotes:m}}function on(e=0){return e>=90?"Top decile":e>=75?"Upper quartile":e>=50?"Above median":e>=30?"Emerging tier":"Early tier"}function an({answers:e,result:t,strategy:n}){const i=l(t?.total,l(n?.score,0)),o=_(e?.age,30),a=String(e?.education||""),r=l(n?.profileSignals?.minLanguageClb,0),c=_(e?.canadianWorkExp,0),s=e?.hasFrench==="yes"||e?.firstOfficialLanguage==="french",d={secondary:0,one_year_post:12,two_year_post:18,bachelors:26,two_or_more:34,masters:45,doctoral:52}[a]||22,m=o>=39?-20:o>=35?-10:o<=24?-8:0,f=r>=9?38:r>=7?24:r>=5?10:0,p=h(c*8,0,24),u=s?18:0,y=Math.round(460+d+m+f+p+u),C=y+28,k=y+52,g=h(Math.round(50+(i-y)/2.1),1,99),b=on(g),S=[{id:"benchmark-p50",label:"Cohort median (P50)",score:y},{id:"benchmark-p75",label:"Upper quartile (P75)",score:C},{id:"benchmark-p90",label:"Top decile (P90)",score:k},{id:"benchmark-user",label:"Your current score",score:i,isUser:!0}],v=(n?.bottlenecks||[]).map(M=>({id:`benchmark-lever-${M.key}`,label:M.label,headroom:l(M.headroom,0)}));return{generatedAt:new Date().toISOString(),percentile:g,benchmarkBand:b,cohort:{ageBand:o<25?"18-24":o<30?"25-29":o<35?"30-34":o<40?"35-39":"40+",educationTier:a||"unknown",languageFloor:r},comparison:S,leverageSignals:v,summary:`You are in the ${b.toLowerCase()} at approximately P${g} against an anonymized peer cohort baseline.`}}function rn({answers:e,result:t,suggestions:n=[],averageCutoff:i,activeDraws:o,categoryInfo:a=[],provinces:r=[],progress:c={},enableAdvancedForecasting:s=!1,eligibleCategoryCount:d=Number.NaN,optimizerConstraints:m=E}){const f=qt({answers:e,result:t,averageCutoff:i,categoryInfo:a,provinces:r,eligibleCategoryCount:d,optimizerConstraints:m}),p=cn({suggestions:n,strategy:f,scoreGap:Math.max((i||0)-(t?.total||0),0),progress:c}),u=s?Ut({activeDraws:o,userScore:t?.total||0,baseConfidence:f.overallConfidence}):null,y=zt({strategy:f,forecast:u,actionPlan:p,averageCutoff:i,userScore:t?.total||0}),C=Zt({strategy:f,forecast:u,averageCutoff:i,userScore:t?.total||0,eligibleCategoryCount:d}),k=Xt({answers:e,result:t,strategy:f,actionPlan:p,opportunityRadar:C}),g=tn({strategy:f,forecast:u,actionPlan:p,digitalTwin:y,commandCenter:k,opportunityRadar:C}),b=nn({answers:e,result:t,strategy:f,actionPlan:p,commandCenter:k,copilot:g}),S=an({answers:e,result:t,strategy:f});return{strategy:f,actionPlan:p,forecast:u,digitalTwin:y,opportunityRadar:C,commandCenter:k,copilot:g,collaboration:b,communityBenchmarks:S}}function N(e,t,n,i,o,a,r,c="Medium",s,d={}){const{startDateIso:m,endDateIso:f,weekWindow:p,dateWindow:u}=z(s,i,o);return{id:e,title:t,rationale:n,window:St(i,o),dayFrom:i,dayTo:o,impact:a,lane:r,priority:c,startDateIso:m,endDateIso:f,weekWindow:p,dateWindow:u,successMetric:d.successMetric||"Task completed with verified profile update.",checkpoint:d.checkpoint||"Run a score recalculation and note delta.",dependencies:d.dependencies||[],cadence:d.cadence||"3 focused sessions per week"}}function cn({suggestions:e=[],strategy:t,scoreGap:n=0,progress:i={}}){const o=e[1],a=t?.top?.title||"Profile Optimization",r=Math.max(l(n),0),c=Ct(new Date),s=[N("plan-baseline","Lock baseline and target score",`Set a concrete target and freeze your baseline profile to avoid random changes. Current gap: ${r} points.`,1,7,0,a,"High",c,{successMetric:"Target score and top lane documented; baseline snapshot saved.",checkpoint:"Save profile with date tag and score target.",cadence:"One 45-minute planning block + one review"}),N("plan-primary-lane",`Execute primary lane: ${a}`,t?.top?.reason||"Follow the highest-impact lane identified by optimizer.",8,30,t?.top?.scoreGain||10,a,"High",c,{successMetric:`Deliver at least 60% of ${a} milestones.`,checkpoint:"Verify measurable progress (test booking, docs, submissions, etc.)."}),N("plan-secondary-lane",o?`Secondary boost: ${o.title}`:"Secondary boost: language and profile precision",o?.description||"Add one additional improvement path to reduce draw uncertainty.",24,50,o?.potentialGain||8,o?.title||"Secondary path","Medium",c,{successMetric:"Secondary lane started with first concrete deliverable completed.",checkpoint:"Compare score delta before/after secondary-lane kickoff.",dependencies:["plan-primary-lane"]}),N("plan-document-pack","Prepare immigration document pack","Collect and verify key documents (identity, education, work proofs, test reports, proof-of-funds readiness).",35,68,0,"Readiness","High",c,{successMetric:"Core document checklist reaches 90% readiness.",checkpoint:"Review missing docs and issue dates.",cadence:"Two short admin sessions weekly"}),N("plan-risk-buffer","Activate fallback lane if progress stalls","If progress velocity is below target, start a backup action immediately (e.g., category-specific adjustment or province-first route).",55,80,6,"Fallback Control","Medium",c,{successMetric:"Fallback lane is selected and started within 7 days of stall signal.",checkpoint:"Mark stall trigger if expected gain is short by 20%+.",dependencies:["plan-primary-lane"]}),N("plan-profile-audit","Profile audit and draw readiness check","Re-evaluate score vs latest draws and category cutoffs. Trigger fallback lane if gap remains above 15 points.",75,90,0,"Risk Control","High",c,{successMetric:"Final 90-day readiness review completed with go/no-go decision.",checkpoint:"Capture current score, active cutoff delta, and next 30-day plan.",dependencies:["plan-document-pack"]})],d=[{label:"Days 1-30",objective:"Baseline lock + launch primary lane",expectedGain:s[1].impact,dateWindow:z(c,1,30).dateWindow},{label:"Days 31-60",objective:"Add secondary lane + document readiness",expectedGain:s[2].impact,dateWindow:z(c,31,60).dateWindow},{label:"Days 61-90",objective:"Fallback control + final draw readiness review",expectedGain:s[4].impact,dateWindow:z(c,61,90).dateWindow}],m=s.filter(k=>!!i[k.id]).length,f=s.length,p=f>0?Math.round(m/f*100):0,u=[...s].filter(k=>!i[k.id]).sort((k,g)=>{const b=pe[g.priority]-pe[k.priority];return b!==0?b:k.dayFrom-g.dayFrom})[0]||null,y=p>=100?"All action-plan tasks are complete. Keep a weekly score monitor to stay draw-ready.":u?`Next best task: ${u.title} (${u.dateWindow}).`:"Continue progressing through the plan in order of priority.",C=[14,30,60,90].map(k=>{const g=j(c,k-1);return{day:k,iso:g.toISOString(),label:X(g)}});return{tasks:s,milestones:d,completedCount:m,totalCount:f,completionPct:p,nextBestTask:u,completionGuidance:y,calendar:{planStartIso:c.toISOString(),planEndIso:j(c,89).toISOString(),reviewDates:C}}}self.onmessage=e=>{const t=e?.data||{},n=t.id;try{const i=rn(t.input||{});self.postMessage({id:n,status:"ok",data:i})}catch(i){self.postMessage({id:n,status:"error",error:String(i?.message||"Worker computation failed")})}}})();
