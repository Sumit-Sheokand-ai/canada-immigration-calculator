import{u as i}from"./data-question-bank-BGQJyrDZ.js";import{i as f,s as c}from"./feature-path-coach-BX4hFirh.js";import{r as d}from"./feature-strategy-hub-Ch1VT8b4.js";const y=300*1e3;let n={data:null,source:"none",fetchedAt:0};function u(e){if(!e||typeof e!="object")return null;const t=String(e.value??"").trim(),r=String(e.label??"").trim();if(!t||!r)return null;const a=typeof e.example=="string"?e.example:"",o=Array.isArray(e.keywords)?e.keywords.map(l=>String(l)):[];return{value:t,label:r,example:a,keywords:o}}function h(e){if(!e||typeof e!="object")return null;const t=String(e.answerKey??"").trim(),r=String(e.title??"").trim();if(!t||!r)return null;const a=String(e.type||"list"),o=Array.isArray(e.options)?e.options.map(u).filter(Boolean):[];return{title:r,answerKey:t,type:a,searchable:!!e.searchable,searchPlaceholder:typeof e.searchPlaceholder=="string"?e.searchPlaceholder:"",options:o}}function m(e){if(!e||typeof e!="object")return;const t=l=>Array.isArray(l)?l.filter(s=>s&&typeof s=="object"&&s.key).map(s=>({key:String(s.key),op:String(s.op||"eq"),value:s.value})):[],r=t(e.all),a=t(e.any),o=t(e.none);if(!(!r.length&&!a.length&&!o.length))return{all:r,any:a,none:o}}function g(e){if(!e||typeof e!="object")return null;const t=String(e.id??"").trim(),r=String(e.type??"").trim();if(!t||!r)return null;const a={id:t,label:String(e.label??""),title:String(e.title??""),subtitle:String(e.subtitle??""),helpTip:String(e.helpTip??""),type:r,answerKey:String(e.answerKey??""),layout:String(e.layout??""),searchable:!!e.searchable,searchPlaceholder:String(e.searchPlaceholder??""),hasNOCSearch:!!e.hasNOCSearch,visibility:m(e.visibility)};if(r==="grouped"){if(a.groups=Array.isArray(e.groups)?e.groups.map(h).filter(Boolean):[],!a.groups.length)return null}else if(a.options=Array.isArray(e.options)?e.options.map(u).filter(Boolean):[],!a.answerKey||!a.options.length)return null;return a}function b(e){let t=[];Array.isArray(e)?t=e:e&&typeof e=="object"&&Array.isArray(e.steps)&&(t=e.steps);const r=t.map(g).filter(Boolean);return r.length>0?r:null}function k(){n={data:null,source:"none",fetchedAt:0}}async function w({forceRefresh:e=!1}={}){const t=d();if(t.forceLocalData||!t.allowRemoteQuestionBank)return n={data:i,source:t.forceLocalData?"local-forced":"local-config",fetchedAt:Date.now()},{status:"ok",source:n.source,data:i};if(!e&&n.data&&Date.now()-n.fetchedAt<y)return{status:"ok",source:n.source,data:n.data};if(f&&c)try{const{data:r,error:a}=await c.from("question_sets").select("id,source,version,payload,updated_at").eq("is_active",!0).order("updated_at",{ascending:!1}).limit(1);if(!a){const o=r?.[0],l=b(o?.payload);if(l)return n={data:l,source:"supabase",fetchedAt:Date.now()},{status:"ok",source:"supabase",data:l}}}catch{}return n={data:i,source:"local-fallback",fetchedAt:Date.now()},{status:"ok",source:"local-fallback",data:i}}export{k as c,w as g};
