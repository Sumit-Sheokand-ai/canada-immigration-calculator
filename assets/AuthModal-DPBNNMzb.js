import{r as i,j as e}from"./vendor-react-Ah1pgjPn.js";import{u as Re,k as J,r as X,l as Pe,s as Le,m as Z}from"./feature-path-coach-Beny58Sb.js";import{r as De,c as ee,d as Ie,e as Me,i as Fe,s as Te,f as Oe,h as qe,j as O,k as q,m as te}from"./index-BqhflTs_.js";import{g as _e,c as _}from"./questionDataSource-DXK4mmFB.js";import{r as ae,j as Ue,k as Be}from"./feature-strategy-hub-oR-PHGUa.js";import"./data-question-bank-BsLULj9F.js";import"./vendor-motion-CtNR3TjB.js";const se=/^\S+@\S+\.\S+$/,C="DELETE",ne=8;function Ye({open:l,onClose:u}){const{isConfigured:p,loading:R,user:r,ensureAuthReady:U,sendEmailMagicLink:ie,verifyEmailOtp:oe,refreshSession:P,signInWithGoogle:ce,signOut:re,updateProfile:le,changePassword:de,deleteAccount:ue}=Re(),[B,he]=i.useState(""),[L,j]=i.useState(""),[y,f]=i.useState("request"),[V,n]=i.useState(""),[z,a]=i.useState(""),[b,N]=i.useState(0),[h,g]=i.useState(()=>De()),[v,x]=i.useState(()=>ae()),[D,I]=i.useState(()=>J()||""),[o,me]=i.useState(()=>({drawSource:"unknown",drawFreshness:"unknown",drawUpdatedAt:"—",categorySource:"unknown",categoryFreshness:"unknown",categoryCount:0,questionSource:"unknown",questionFreshness:"unknown",questionCount:0,activePolicy:X(),policyAutopilot:ee(),refreshedAt:""})),[G,M]=i.useState(""),[$,F]=i.useState(""),[Q,T]=i.useState(""),K=i.useId(),ge=i.useMemo(()=>r?"Account":"Login / Signup",[r]),ye=i.useMemo(()=>Pe(),[]),W=Fe(),c=V!=="",d=t=>V===t,w=i.useCallback(async({forceRefresh:t=!1,silent:s=!1}={})=>{s||(n("refreshAdminMeta"),a(""));try{const[m,S,E]=await Promise.all([Ie({forceRefresh:t}),Me({forceRefresh:t}),_e({forceRefresh:t})]);me({drawSource:m?.source||"unknown",drawFreshness:m?.freshness||"unknown",drawUpdatedAt:m?.data?.lastUpdated||"—",categorySource:S?.source||"unknown",categoryFreshness:S?.freshness||"unknown",categoryCount:Array.isArray(S?.data)?S.data.length:0,questionSource:E?.source||"unknown",questionFreshness:E?.freshness||"unknown",questionCount:Array.isArray(E?.data)?E.data.length:0,activePolicy:X(),policyAutopilot:ee(),refreshedAt:new Date().toISOString()}),s||a("Admin metadata refreshed.")}catch(m){s||a(m.message||"Could not refresh admin metadata.")}finally{s||n("")}},[]);if(i.useEffect(()=>{!l||!p||U().catch(()=>{})},[U,p,l]),i.useEffect(()=>{if(!l||b<=0)return;const t=window.setInterval(()=>{N(s=>s<=1?0:s-1)},1e3);return()=>window.clearInterval(t)},[l,b]),i.useEffect(()=>{!l||!r||(g(t=>({...t,profileName:r.user_metadata?.full_name||t.profileName||"",contactEmail:t.contactEmail||r.email||""})),x(ae()),I(J()||""),w({silent:!0}))},[l,w,r]),i.useEffect(()=>{if(!l||!r||!(y==="sent"||y==="verify"))return;a("Signed in successfully.");const t=window.setTimeout(()=>u(),500);return()=>window.clearTimeout(t)},[u,l,y,r]),i.useEffect(()=>{l||(f("request"),j(""),a(""),n(""),N(0),M(""),F(""),T(""))},[l]),i.useEffect(()=>{if(!l)return;const t=document.body.style.overflow,s=m=>{m.key==="Escape"&&u()};return document.body.style.overflow="hidden",window.addEventListener("keydown",s),()=>{window.removeEventListener("keydown",s),document.body.style.overflow=t}},[u,l]),!l)return null;const k=B.trim().toLowerCase(),Y=Q.trim().toUpperCase(),A=t=>{const s=document.getElementById(t);s&&s.scrollIntoView({behavior:"smooth",block:"start"})},H=async()=>{if(!k||!se.test(k)){a("Please enter a valid email address.");return}n("sendMagicLink"),a("");try{await ie(k),f("sent"),j(""),N(25),a("Magic link sent. Open your email and click the secure sign-in link.")}catch(t){a(t.message||"Could not send magic link.")}finally{n("")}},pe=async()=>{n("checkMagicLink"),a("");try{(await P())?.user?(a("Signed in successfully."),f("request"),window.setTimeout(()=>u(),500)):a("No active session found yet. Click the magic link from your email in this browser, then try again.")}catch(t){a(t.message||"Could not refresh session.")}finally{n("")}},fe=async()=>{b>0||await H()},be=async()=>{if(!k||!L.trim()){a("Enter your email and 6-digit code.");return}n("verifyCode"),a("");try{await oe(k,L.trim()),await P(),a("Signed in successfully."),f("request"),j(""),window.setTimeout(()=>u(),500)}catch(t){a(t.message||"Verification failed.")}finally{n("")}},xe=async()=>{n("googleAuth"),a("");try{await ce(),a("Redirecting to Google...")}catch(t){a(t.message||"Google login failed.")}finally{n("")}},we=async()=>{const t={...h,profileName:(h.profileName||"").trim(),contactEmail:(h.contactEmail||"").trim().toLowerCase()};if(t.contactEmail&&!se.test(t.contactEmail)){a("Please enter a valid contact email.");return}n("saveSettings"),a("");try{await le({fullName:t.profileName}),Te(t),g(t),W&&r?.id&&await Promise.all([Oe(r.id,t.defaultDrawAlerts),qe(r.id,t.contactEmail||r.email||"")]),a("Account settings saved.")}catch(s){a(s.message||"Could not save account settings.")}finally{n("")}},je=async()=>{const t=G.trim(),s=$.trim();if(t.length<ne){a(`Password must be at least ${ne} characters.`);return}if(t!==s){a("New password and confirmation do not match.");return}n("changePassword"),a("");try{await de(t),M(""),F(""),a("Password updated successfully.")}catch(m){a(m.message||"Could not change password.")}finally{n("")}},ve=()=>{{a("Membership management is unavailable. Add VITE_STRIPE_BILLING_PORTAL_URL.");return}},ke=async()=>{if(Y!==C){a(`Type ${C} to confirm account deletion.`);return}n("deleteAccount"),a("");try{await ue(),T(""),a("Account deleted."),window.setTimeout(()=>u(),350)}catch(t){a(t.message||"Could not delete account.")}finally{n("")}},Ce=async()=>{n("refreshSession"),a("");try{await P(),a("Session refreshed.")}catch(t){a(t.message||"Session refresh failed.")}finally{n("")}},Ne=async()=>{n("signOut"),a("");try{await re(),a("Signed out."),window.setTimeout(()=>u(),400)}catch(t){a(t.message||"Sign out failed.")}finally{n("")}},Ae=async()=>{n("saveAdminControls"),a("");try{Ue(v),D?Le(D):Z(),O(),q(),_();const t=te({reason:"admin_controls_save",force:!0});await w({forceRefresh:!0,silent:!0}),a(`Admin controls saved. Policy autopilot recalculated ${Number(t?.recalculation?.updated||0)} profile(s).`)}catch(t){a(t.message||"Could not save admin controls.")}finally{n("")}},Se=async()=>{n("resetAdminControls"),a("");try{x(Be()),Z(),I(""),O(),q(),_();const t=te({reason:"admin_controls_reset",force:!0});await w({forceRefresh:!0,silent:!0}),a(`Admin controls reset to defaults. Policy autopilot recalculated ${Number(t?.recalculation?.updated||0)} profile(s).`)}catch(t){a(t.message||"Could not reset admin controls.")}finally{n("")}},Ee=async()=>{n("clearAdminCaches"),a("");try{O(),q(),_(),await w({forceRefresh:!0,silent:!0}),a("Draw/category/question caches cleared.")}catch(t){a(t.message||"Could not clear caches.")}finally{n("")}};return e.jsx("div",{className:"auth-modal-backdrop",onClick:u,role:"presentation",children:e.jsxs("div",{className:"auth-modal",role:"dialog","aria-modal":"true","aria-labelledby":K,onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"auth-modal-head",children:[e.jsx("h3",{id:K,children:ge}),e.jsx("button",{type:"button",className:"auth-close",onClick:u,"aria-label":"Close dialog",children:"×"})]}),e.jsxs("div",{className:"auth-modal-scroll",children:[!p&&e.jsx("p",{className:"auth-note",children:"Auth is unavailable. Add `VITE_SUPABASE_URL` and `VITE_SUPABASE_ANON_KEY`."}),p&&R&&e.jsx("p",{className:"auth-note",children:"Checking session..."}),p&&!R&&r&&e.jsxs("div",{className:"auth-body",children:[e.jsxs("p",{className:"auth-note",children:["Signed in as ",e.jsx("strong",{children:r.email})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section",children:[e.jsx("h4",{children:"Account actions"}),e.jsxs("div",{className:"auth-action-shortcuts",children:[e.jsx("button",{type:"button",className:"action-btn",onClick:()=>A("auth-security"),children:"Change password"}),e.jsx("button",{type:"button",className:"action-btn",onClick:()=>A("auth-admin"),children:"Admin controls"}),e.jsx("button",{type:"button",className:"action-btn",onClick:()=>A("auth-membership"),children:"Remove membership"}),e.jsx("button",{type:"button",className:"action-btn auth-btn-danger",onClick:()=>A("auth-danger-zone"),children:"Delete account"})]})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section",children:[e.jsx("h4",{children:"Account settings"}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Display name"}),e.jsx("input",{type:"text",value:h.profileName,onChange:t=>g(s=>({...s,profileName:t.target.value})),placeholder:"Your name"})]}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Contact email for draw alerts"}),e.jsx("input",{type:"email",value:h.contactEmail,onChange:t=>g(s=>({...s,contactEmail:t.target.value})),placeholder:"you@example.com"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:h.defaultDrawAlerts,onChange:t=>g(s=>({...s,defaultDrawAlerts:t.target.checked}))}),e.jsx("span",{children:"Enable draw alerts by default"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:h.autoSyncProfiles,onChange:t=>g(s=>({...s,autoSyncProfiles:t.target.checked}))}),e.jsx("span",{children:"Auto-sync saved profiles"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:h.autoSaveProgress,onChange:t=>g(s=>({...s,autoSaveProgress:t.target.checked}))}),e.jsx("span",{children:"Auto-save wizard progress on this device"})]}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Animation intensity"}),e.jsxs("select",{value:h.motionIntensity||"full",onChange:t=>g(s=>({...s,motionIntensity:t.target.value})),children:[e.jsx("option",{value:"full",children:"Full"}),e.jsx("option",{value:"subtle",children:"Subtle"}),e.jsx("option",{value:"off",children:"Off"})]})]}),!W&&e.jsx("p",{className:"auth-note",children:"Cloud account settings require Supabase env vars."})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section",id:"auth-admin",children:[e.jsx("h4",{children:"Admin controls"}),e.jsx("p",{className:"auth-note",children:"Runtime controls for data mode, policy versioning, and source metadata."}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:v.forceLocalData,onChange:t=>x(s=>({...s,forceLocalData:t.target.checked}))}),e.jsx("span",{children:"Force local data mode (disable remote Supabase reads)"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:v.allowRemoteQuestionBank,onChange:t=>x(s=>({...s,allowRemoteQuestionBank:t.target.checked}))}),e.jsx("span",{children:"Allow remote question-bank payloads"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:v.enableAdvancedForecasting,onChange:t=>x(s=>({...s,enableAdvancedForecasting:t.target.checked}))}),e.jsx("span",{children:"Enable advanced trend forecasting widgets"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:v.enablePerfTelemetry,onChange:t=>x(s=>({...s,enablePerfTelemetry:t.target.checked}))}),e.jsx("span",{children:"Enable route/performance telemetry events"})]}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Scoring policy override"}),e.jsxs("select",{value:D,onChange:t=>I(t.target.value),children:[e.jsx("option",{value:"",children:"Automatic (effective-date ruleset)"}),ye.map(t=>e.jsxs("option",{value:t.id,children:[t.id," · effective ",t.effectiveDate]},t.id))]})]}),e.jsxs("div",{className:"auth-admin-meta",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Active policy:"})," ",o.activePolicy?.id||"—"," (",o.activePolicy?.source||"unknown",")"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Policy autopilot:"})," ",o.policyAutopilot?.activePolicyId||"—"," · Registry ",o.policyAutopilot?.registryVersion||"—"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Autopilot last recalculation:"})," ",o.policyAutopilot?.lastRecalculation?.recalculatedAt?new Date(o.policyAutopilot.lastRecalculation.recalculatedAt).toLocaleString():"—"," · Updated ",Number(o.policyAutopilot?.lastRecalculation?.updated||0)," profile(s)"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Draw source:"})," ",o.drawSource," (",o.drawFreshness,") · Updated ",o.drawUpdatedAt]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Category source:"})," ",o.categorySource," (",o.categoryFreshness,") · ",o.categoryCount," categories"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Question bank:"})," ",o.questionSource," (",o.questionFreshness,") · ",o.questionCount," steps"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Metadata refreshed:"})," ",o.refreshedAt?new Date(o.refreshedAt).toLocaleString():"—"]})]}),e.jsxs("div",{className:"auth-actions",children:[e.jsx("button",{type:"button",className:"action-btn auth-btn-primary",disabled:c,onClick:Ae,children:d("saveAdminControls")?"Saving controls...":"Save controls"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:()=>{w({forceRefresh:!0})},children:d("refreshAdminMeta")?"Refreshing metadata...":"Refresh metadata"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:Ee,children:d("clearAdminCaches")?"Clearing caches...":"Clear caches"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:Se,children:d("resetAdminControls")?"Resetting...":"Reset controls"})]})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section",id:"auth-security",children:[e.jsx("h4",{children:"Security"}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"New password"}),e.jsx("input",{type:"password",value:G,onChange:t=>M(t.target.value),placeholder:"At least 8 characters",autoComplete:"new-password"})]}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Confirm new password"}),e.jsx("input",{type:"password",value:$,onChange:t=>F(t.target.value),placeholder:"Re-enter new password",autoComplete:"new-password"})]}),e.jsx("div",{className:"auth-actions",children:e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:je,children:d("changePassword")?"Updating...":"Change password"})})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section",id:"auth-membership",children:[e.jsx("h4",{children:"Membership"}),e.jsx("p",{className:"auth-note",children:"Remove or manage your membership from the billing portal."}),e.jsx("div",{className:"auth-actions",children:e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:ve,children:"Remove membership"})})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section auth-danger-zone",id:"auth-danger-zone",children:[e.jsx("h4",{children:"Danger zone"}),e.jsxs("p",{className:"auth-note",children:["This permanently deletes your account. Type ",e.jsx("strong",{children:C})," to confirm."]}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Confirmation"}),e.jsx("input",{type:"text",value:Q,onChange:t=>T(t.target.value),placeholder:C})]}),e.jsx("div",{className:"auth-actions",children:e.jsx("button",{type:"button",className:"action-btn auth-btn-danger",disabled:c||Y!==C,onClick:ke,children:d("deleteAccount")?"Deleting...":"Delete account"})})]}),e.jsxs("div",{className:"auth-actions",children:[e.jsx("button",{type:"button",className:"action-btn auth-btn-primary",disabled:c,onClick:we,children:d("saveSettings")?"Saving...":"Save settings"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:Ce,children:d("refreshSession")?"Refreshing...":"Refresh session"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:Ne,children:d("signOut")?"Signing out...":"Sign out"})]})]}),p&&!R&&!r&&e.jsxs("div",{className:"auth-body",children:[e.jsx("p",{className:"auth-note",children:"Sign in with a magic link (recommended) or verify manually with an email code."}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Email"}),e.jsx("input",{type:"email",placeholder:"you@example.com",value:B,onChange:t=>he(t.target.value),autoFocus:!0})]}),y==="verify"&&e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Email verification code"}),e.jsx("input",{type:"text",inputMode:"numeric",placeholder:"Enter code",value:L,onChange:t=>j(t.target.value)})]}),e.jsxs("div",{className:"auth-actions",children:[y==="request"?e.jsx("button",{type:"button",className:"action-btn auth-btn-primary",disabled:c,onClick:H,children:d("sendMagicLink")?"Sending...":"Send magic link"}):y==="sent"?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"action-btn auth-btn-primary",disabled:c,onClick:pe,children:d("checkMagicLink")?"Checking...":"I clicked the magic link"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c||b>0,onClick:fe,children:b>0?`Resend in ${b}s`:"Resend magic link"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:()=>{f("verify"),a("If your email contains a code, enter it below.")},children:"Use email code instead"})]}):e.jsx("button",{type:"button",className:"action-btn auth-btn-primary",disabled:c,onClick:be,children:d("verifyCode")?"Verifying...":"Verify and sign in"}),e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:xe,children:d("googleAuth")?"Redirecting...":"Continue with Google"}),y!=="request"&&e.jsx("button",{type:"button",className:"action-btn",disabled:c,onClick:()=>{f("request"),j(""),a(""),N(0)},children:"Back"})]})]}),z&&e.jsx("p",{className:"auth-status",role:"status","aria-live":"polite",children:z})]})]})})}export{Ye as default};
