import{r as i,j as e}from"./vendor-react-Ah1pgjPn.js";import{u as ce}from"./feature-path-coach-DvhzPNyQ.js";import{r as le,i as oe,s as re,c as de,d as ue}from"./index-8WQrT5pX.js";import"./data-question-bank-F-s7nTqV.js";import"./vendor-supabase-BZ0N5lZN.js";import"./vendor-motion-DURBmaq0.js";import"./feature-strategy-hub-DZoh82vu.js";const q=/^\S+@\S+\.\S+$/,y="DELETE",V=8;function xe({open:o,onClose:r}){const{isConfigured:x,loading:j,user:c,sendEmailMagicLink:z,verifyEmailOtp:G,refreshSession:v,signInWithGoogle:B,signOut:F,updateProfile:$,changePassword:K,deleteAccount:W}=ce(),[P,Y]=i.useState(""),[N,p]=i.useState(""),[m,g]=i.useState("request"),[I,n]=i.useState(""),[L,s]=i.useState(""),[f,w]=i.useState(0),[d,h]=i.useState(()=>le()),[R,S]=i.useState(""),[T,k]=i.useState(""),[M,C]=i.useState(""),_=i.useId(),H=i.useMemo(()=>c?"Account":"Login / Signup",[c]),D=oe(),l=I!=="",u=t=>I===t;if(i.useEffect(()=>{if(!o||f<=0)return;const t=window.setInterval(()=>{w(a=>a<=1?0:a-1)},1e3);return()=>window.clearInterval(t)},[o,f]),i.useEffect(()=>{!o||!c||h(t=>({...t,profileName:c.user_metadata?.full_name||t.profileName||"",contactEmail:t.contactEmail||c.email||""}))},[o,c]),i.useEffect(()=>{if(!o||!c||!(m==="sent"||m==="verify"))return;s("Signed in successfully.");const t=window.setTimeout(()=>r(),500);return()=>window.clearTimeout(t)},[r,o,m,c]),i.useEffect(()=>{o||(g("request"),p(""),s(""),n(""),w(0),S(""),k(""),C(""))},[o]),i.useEffect(()=>{if(!o)return;const t=document.body.style.overflow,a=A=>{A.key==="Escape"&&r()};return document.body.style.overflow="hidden",window.addEventListener("keydown",a),()=>{window.removeEventListener("keydown",a),document.body.style.overflow=t}},[r,o]),!o)return null;const b=P.trim().toLowerCase(),O=M.trim().toUpperCase(),E=t=>{const a=document.getElementById(t);a&&a.scrollIntoView({behavior:"smooth",block:"start"})},U=async()=>{if(!b||!q.test(b)){s("Please enter a valid email address.");return}n("sendMagicLink"),s("");try{await z(b),g("sent"),p(""),w(25),s("Magic link sent. Open your email and click the secure sign-in link.")}catch(t){s(t.message||"Could not send magic link.")}finally{n("")}},J=async()=>{n("checkMagicLink"),s("");try{(await v())?.user?(s("Signed in successfully."),g("request"),window.setTimeout(()=>r(),500)):s("No active session found yet. Click the magic link from your email in this browser, then try again.")}catch(t){s(t.message||"Could not refresh session.")}finally{n("")}},Q=async()=>{f>0||await U()},X=async()=>{if(!b||!N.trim()){s("Enter your email and 6-digit code.");return}n("verifyCode"),s("");try{await G(b,N.trim()),await v(),s("Signed in successfully."),g("request"),p(""),window.setTimeout(()=>r(),500)}catch(t){s(t.message||"Verification failed.")}finally{n("")}},Z=async()=>{n("googleAuth"),s("");try{await B(),s("Redirecting to Google...")}catch(t){s(t.message||"Google login failed.")}finally{n("")}},ee=async()=>{const t={...d,profileName:(d.profileName||"").trim(),contactEmail:(d.contactEmail||"").trim().toLowerCase()};if(t.contactEmail&&!q.test(t.contactEmail)){s("Please enter a valid contact email.");return}n("saveSettings"),s("");try{await $({fullName:t.profileName}),re(t),h(t),D&&c?.id&&await Promise.all([de(c.id,t.defaultDrawAlerts),ue(c.id,t.contactEmail||c.email||"")]),s("Account settings saved.")}catch(a){s(a.message||"Could not save account settings.")}finally{n("")}},te=async()=>{const t=R.trim(),a=T.trim();if(t.length<V){s(`Password must be at least ${V} characters.`);return}if(t!==a){s("New password and confirmation do not match.");return}n("changePassword"),s("");try{await K(t),S(""),k(""),s("Password updated successfully.")}catch(A){s(A.message||"Could not change password.")}finally{n("")}},se=()=>{{s("Membership management is unavailable. Add VITE_STRIPE_BILLING_PORTAL_URL.");return}},ae=async()=>{if(O!==y){s(`Type ${y} to confirm account deletion.`);return}n("deleteAccount"),s("");try{await W(),C(""),s("Account deleted."),window.setTimeout(()=>r(),350)}catch(t){s(t.message||"Could not delete account.")}finally{n("")}},ne=async()=>{n("refreshSession"),s("");try{await v(),s("Session refreshed.")}catch(t){s(t.message||"Session refresh failed.")}finally{n("")}},ie=async()=>{n("signOut"),s("");try{await F(),s("Signed out."),window.setTimeout(()=>r(),400)}catch(t){s(t.message||"Sign out failed.")}finally{n("")}};return e.jsx("div",{className:"auth-modal-backdrop",onClick:r,role:"presentation",children:e.jsxs("div",{className:"auth-modal",role:"dialog","aria-modal":"true","aria-labelledby":_,onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"auth-modal-head",children:[e.jsx("h3",{id:_,children:H}),e.jsx("button",{type:"button",className:"auth-close",onClick:r,"aria-label":"Close dialog",children:"Ã—"})]}),e.jsxs("div",{className:"auth-modal-scroll",children:[!x&&e.jsx("p",{className:"auth-note",children:"Auth is unavailable. Add `VITE_SUPABASE_URL` and `VITE_SUPABASE_ANON_KEY`."}),x&&j&&e.jsx("p",{className:"auth-note",children:"Checking session..."}),x&&!j&&c&&e.jsxs("div",{className:"auth-body",children:[e.jsxs("p",{className:"auth-note",children:["Signed in as ",e.jsx("strong",{children:c.email})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section",children:[e.jsx("h4",{children:"Account actions"}),e.jsxs("div",{className:"auth-action-shortcuts",children:[e.jsx("button",{type:"button",className:"action-btn",onClick:()=>E("auth-security"),children:"Change password"}),e.jsx("button",{type:"button",className:"action-btn",onClick:()=>E("auth-membership"),children:"Remove membership"}),e.jsx("button",{type:"button",className:"action-btn auth-btn-danger",onClick:()=>E("auth-danger-zone"),children:"Delete account"})]})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section",children:[e.jsx("h4",{children:"Account settings"}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Display name"}),e.jsx("input",{type:"text",value:d.profileName,onChange:t=>h(a=>({...a,profileName:t.target.value})),placeholder:"Your name"})]}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Contact email for draw alerts"}),e.jsx("input",{type:"email",value:d.contactEmail,onChange:t=>h(a=>({...a,contactEmail:t.target.value})),placeholder:"you@example.com"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:d.defaultDrawAlerts,onChange:t=>h(a=>({...a,defaultDrawAlerts:t.target.checked}))}),e.jsx("span",{children:"Enable draw alerts by default"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:d.autoSyncProfiles,onChange:t=>h(a=>({...a,autoSyncProfiles:t.target.checked}))}),e.jsx("span",{children:"Auto-sync saved profiles"})]}),e.jsxs("label",{className:"auth-check-row",children:[e.jsx("input",{type:"checkbox",checked:d.autoSaveProgress,onChange:t=>h(a=>({...a,autoSaveProgress:t.target.checked}))}),e.jsx("span",{children:"Auto-save wizard progress on this device"})]}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Animation intensity"}),e.jsxs("select",{value:d.motionIntensity||"full",onChange:t=>h(a=>({...a,motionIntensity:t.target.value})),children:[e.jsx("option",{value:"full",children:"Full"}),e.jsx("option",{value:"subtle",children:"Subtle"}),e.jsx("option",{value:"off",children:"Off"})]})]}),!D&&e.jsx("p",{className:"auth-note",children:"Cloud account settings require Supabase env vars."})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section",id:"auth-security",children:[e.jsx("h4",{children:"Security"}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"New password"}),e.jsx("input",{type:"password",value:R,onChange:t=>S(t.target.value),placeholder:"At least 8 characters",autoComplete:"new-password"})]}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Confirm new password"}),e.jsx("input",{type:"password",value:T,onChange:t=>k(t.target.value),placeholder:"Re-enter new password",autoComplete:"new-password"})]}),e.jsx("div",{className:"auth-actions",children:e.jsx("button",{type:"button",className:"action-btn",disabled:l,onClick:te,children:u("changePassword")?"Updating...":"Change password"})})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section",id:"auth-membership",children:[e.jsx("h4",{children:"Membership"}),e.jsx("p",{className:"auth-note",children:"Remove or manage your membership from the billing portal."}),e.jsx("div",{className:"auth-actions",children:e.jsx("button",{type:"button",className:"action-btn",disabled:l,onClick:se,children:"Remove membership"})})]}),e.jsxs("div",{className:"auth-settings-card auth-settings-section auth-danger-zone",id:"auth-danger-zone",children:[e.jsx("h4",{children:"Danger zone"}),e.jsxs("p",{className:"auth-note",children:["This permanently deletes your account. Type ",e.jsx("strong",{children:y})," to confirm."]}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Confirmation"}),e.jsx("input",{type:"text",value:M,onChange:t=>C(t.target.value),placeholder:y})]}),e.jsx("div",{className:"auth-actions",children:e.jsx("button",{type:"button",className:"action-btn auth-btn-danger",disabled:l||O!==y,onClick:ae,children:u("deleteAccount")?"Deleting...":"Delete account"})})]}),e.jsxs("div",{className:"auth-actions",children:[e.jsx("button",{type:"button",className:"action-btn auth-btn-primary",disabled:l,onClick:ee,children:u("saveSettings")?"Saving...":"Save settings"}),e.jsx("button",{type:"button",className:"action-btn",disabled:l,onClick:ne,children:u("refreshSession")?"Refreshing...":"Refresh session"}),e.jsx("button",{type:"button",className:"action-btn",disabled:l,onClick:ie,children:u("signOut")?"Signing out...":"Sign out"})]})]}),x&&!j&&!c&&e.jsxs("div",{className:"auth-body",children:[e.jsx("p",{className:"auth-note",children:"Sign in with a magic link (recommended) or verify manually with an email code."}),e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Email"}),e.jsx("input",{type:"email",placeholder:"you@example.com",value:P,onChange:t=>Y(t.target.value),autoFocus:!0})]}),m==="verify"&&e.jsxs("label",{className:"wi-field",children:[e.jsx("span",{children:"Email verification code"}),e.jsx("input",{type:"text",inputMode:"numeric",placeholder:"Enter code",value:N,onChange:t=>p(t.target.value)})]}),e.jsxs("div",{className:"auth-actions",children:[m==="request"?e.jsx("button",{type:"button",className:"action-btn auth-btn-primary",disabled:l,onClick:U,children:u("sendMagicLink")?"Sending...":"Send magic link"}):m==="sent"?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"action-btn auth-btn-primary",disabled:l,onClick:J,children:u("checkMagicLink")?"Checking...":"I clicked the magic link"}),e.jsx("button",{type:"button",className:"action-btn",disabled:l||f>0,onClick:Q,children:f>0?`Resend in ${f}s`:"Resend magic link"}),e.jsx("button",{type:"button",className:"action-btn",disabled:l,onClick:()=>{g("verify"),s("If your email contains a code, enter it below.")},children:"Use email code instead"})]}):e.jsx("button",{type:"button",className:"action-btn auth-btn-primary",disabled:l,onClick:X,children:u("verifyCode")?"Verifying...":"Verify and sign in"}),e.jsx("button",{type:"button",className:"action-btn",disabled:l,onClick:Z,children:u("googleAuth")?"Redirecting...":"Continue with Google"}),m!=="request"&&e.jsx("button",{type:"button",className:"action-btn",disabled:l,onClick:()=>{g("request"),p(""),s(""),w(0)},children:"Back"})]})]}),L&&e.jsx("p",{className:"auth-status",role:"status","aria-live":"polite",children:L})]})]})})}export{xe as default};
