import {
  nocTEER,
  ieltsBands,
  celpipLevels,
  clbLevels,
  tefBands,
  tcfBands,
} from './crsData.js';

const bandOpts = (arr, prefix = '') => arr.map((b) => ({ value: String(b), label: `${prefix}${b}` }));
const clbOpts = bandOpts(clbLevels, 'CLB ');
const yesNo = [
  { value: 'yes', label: 'Yes' },
  { value: 'no', label: 'No' },
];
const workOpts = [
  { value: '0', label: 'None' },
  { value: '1', label: '1 year' },
  { value: '2', label: '2 years' },
  { value: '3', label: '3 years' },
  { value: '4', label: '4 years' },
  { value: '5', label: '5+ years' },
];

function buildAgeOptions() {
  const opts = [{ value: '17', label: 'Under 18' }];
  for (let a = 18; a <= 47; a += 1) {
    opts.push({ value: String(a), label: `${a} years` });
  }
  opts.push({ value: '48', label: '48 or older' });
  return opts;
}

const countryOptions = [
  { value: 'india', label: 'India' },
  { value: 'china', label: 'China' },
  { value: 'philippines', label: 'Philippines' },
  { value: 'nigeria', label: 'Nigeria' },
  { value: 'pakistan', label: 'Pakistan' },
  { value: 'bangladesh', label: 'Bangladesh' },
  { value: 'nepal', label: 'Nepal' },
  { value: 'sri_lanka', label: 'Sri Lanka' },
  { value: 'uae', label: 'United Arab Emirates' },
  { value: 'saudi_arabia', label: 'Saudi Arabia' },
  { value: 'qatar', label: 'Qatar' },
  { value: 'oman', label: 'Oman' },
  { value: 'kuwait', label: 'Kuwait' },
  { value: 'bahrain', label: 'Bahrain' },
  { value: 'usa', label: 'United States' },
  { value: 'canada', label: 'Canada' },
  { value: 'uk', label: 'United Kingdom' },
  { value: 'ireland', label: 'Ireland' },
  { value: 'australia', label: 'Australia' },
  { value: 'new_zealand', label: 'New Zealand' },
  { value: 'france', label: 'France' },
  { value: 'germany', label: 'Germany' },
  { value: 'italy', label: 'Italy' },
  { value: 'spain', label: 'Spain' },
  { value: 'netherlands', label: 'Netherlands' },
  { value: 'belgium', label: 'Belgium' },
  { value: 'sweden', label: 'Sweden' },
  { value: 'norway', label: 'Norway' },
  { value: 'denmark', label: 'Denmark' },
  { value: 'finland', label: 'Finland' },
  { value: 'switzerland', label: 'Switzerland' },
  { value: 'poland', label: 'Poland' },
  { value: 'romania', label: 'Romania' },
  { value: 'ukraine', label: 'Ukraine' },
  { value: 'russia', label: 'Russia' },
  { value: 'turkiye', label: 'Türkiye' },
  { value: 'iran', label: 'Iran' },
  { value: 'iraq', label: 'Iraq' },
  { value: 'jordan', label: 'Jordan' },
  { value: 'egypt', label: 'Egypt' },
  { value: 'morocco', label: 'Morocco' },
  { value: 'algeria', label: 'Algeria' },
  { value: 'kenya', label: 'Kenya' },
  { value: 'ghana', label: 'Ghana' },
  { value: 'south_africa', label: 'South Africa' },
  { value: 'brazil', label: 'Brazil' },
  { value: 'mexico', label: 'Mexico' },
  { value: 'argentina', label: 'Argentina' },
  { value: 'colombia', label: 'Colombia' },
  { value: 'peru', label: 'Peru' },
  { value: 'chile', label: 'Chile' },
  { value: 'japan', label: 'Japan' },
  { value: 'south_korea', label: 'South Korea' },
  { value: 'vietnam', label: 'Vietnam' },
  { value: 'thailand', label: 'Thailand' },
  { value: 'malaysia', label: 'Malaysia' },
  { value: 'indonesia', label: 'Indonesia' },
  { value: 'singapore', label: 'Singapore' },
  { value: 'hong_kong', label: 'Hong Kong' },
  { value: 'taiwan', label: 'Taiwan' },
  { value: 'other', label: 'Other / Prefer not to say' },
];

const provinceOptions = [
  { value: 'ontario', label: 'Ontario (ON)' },
  { value: 'british_columbia', label: 'British Columbia (BC)' },
  { value: 'alberta', label: 'Alberta (AB)' },
  { value: 'saskatchewan', label: 'Saskatchewan (SK)' },
  { value: 'manitoba', label: 'Manitoba (MB)' },
  { value: 'quebec', label: 'Quebec (QC)' },
  { value: 'nova_scotia', label: 'Nova Scotia (NS)' },
  { value: 'new_brunswick', label: 'New Brunswick (NB)' },
  { value: 'newfoundland_labrador', label: 'Newfoundland and Labrador (NL)' },
  { value: 'prince_edward_island', label: 'Prince Edward Island (PEI)' },
  { value: 'northwest_territories', label: 'Northwest Territories (NT)' },
  { value: 'nunavut', label: 'Nunavut (NU)' },
  { value: 'yukon', label: 'Yukon (YT)' },
  { value: 'undecided', label: 'Undecided / Open to multiple provinces' },
];

const eq = (key, value) => ({ key, op: 'eq', value });
const neq = (key, value) => ({ key, op: 'neq', value });
const inList = (key, value) => ({ key, op: 'in', value });
const all = (...rules) => ({ all: rules });
const allAny = (allRules, anyRules) => ({ all: allRules, any: anyRules });

const baseVisibility = all(neq('knowsScore', 'yes'));
const advancedVisibility = all(neq('knowsScore', 'yes'), eq('answerMode', 'advanced'));

export const QUESTION_BANK_VERSION = '2026-02-14-v1';

export const fallbackQuestionBank = [
  {
    id: 'pathway',
    label: 'Pathway',
    title: 'Which immigration pathway are you targeting?',
    subtitle: 'Pick your best current pathway. You can still compare others later.',
    type: 'single',
    answerKey: 'pathway',
    options: [
      { value: 'fsw', label: 'Federal Skilled Worker (FSW)', example: 'Skilled workers outside Canada with eligible work experience' },
      { value: 'cec', label: 'Canadian Experience Class (CEC)', example: 'Candidates with recent Canadian skilled work experience' },
      { value: 'fst', label: 'Federal Skilled Trades (FST)', example: 'Trade occupations with eligibility through trades pathway' },
      { value: 'pnp', label: 'Provincial Nominee Program (PNP)', example: 'Province nomination streams and EE-linked nominations' },
      { value: 'aip', label: 'Atlantic Immigration Program (AIP)', example: 'Designated employers in Atlantic provinces' },
      { value: 'other', label: 'Other / Not sure yet', example: 'I’m still exploring pathways' },
    ],
  },
  {
    id: 'knowsScore',
    label: 'Known Score',
    title: 'Do you already know your CRS score?',
    subtitle: 'If yes, you can still save time with approximate-range mode.',
    type: 'single',
    answerKey: 'knowsScore',
    options: [
      { value: 'yes', label: 'Yes, I know my approximate score' },
      { value: 'no', label: 'No, calculate it in detail' },
    ],
  },
  {
    id: 'scoreRange',
    label: 'Score Range',
    title: 'Select your approximate score range',
    type: 'single',
    answerKey: 'scoreRange',
    visibility: all(eq('knowsScore', 'yes')),
    options: [
      { value: '325', label: '300–349' },
      { value: '375', label: '350–399' },
      { value: '425', label: '400–449' },
      { value: '475', label: '450–499' },
      { value: '525', label: '500–549' },
      { value: '575', label: '550+' },
    ],
  },
  {
    id: 'answerMode',
    label: 'Detail Mode',
    title: 'How detailed should this assessment be?',
    subtitle: 'Advanced includes full profile context and additional planning questions.',
    type: 'single',
    answerKey: 'answerMode',
    visibility: baseVisibility,
    options: [
      { value: 'basic', label: 'Basic (faster)', example: 'Core CRS profile only' },
      { value: 'advanced', label: 'Advanced (full profile)', example: 'Adds complete context and planning inputs' },
    ],
  },
  {
    id: 'age',
    label: 'Age',
    title: 'Your age at expected application time',
    subtitle: 'CRS age points are highest between 20 and 29.',
    type: 'grid',
    answerKey: 'age',
    searchable: true,
    searchPlaceholder: 'Search age...',
    visibility: baseVisibility,
    options: buildAgeOptions(),
  },
  {
    id: 'education',
    label: 'Education',
    title: 'Highest education credential',
    subtitle: 'Select the closest Canadian-equivalent completed credential.',
    helpTip: 'Foreign credentials usually need an ECA to claim CRS points.',
    type: 'single',
    answerKey: 'education',
    visibility: baseVisibility,
    options: [
      { value: 'less_than_secondary', label: 'Less than high school' },
      { value: 'secondary', label: 'High school diploma' },
      { value: 'one_year_post', label: '1-year post-secondary credential' },
      { value: 'two_year_post', label: '2-year post-secondary credential' },
      { value: 'bachelors', label: 'Bachelor’s degree (3+ years)' },
      { value: 'two_or_more', label: 'Two or more credentials (one 3+ years)' },
      { value: 'masters', label: 'Master’s / Professional degree' },
      { value: 'doctoral', label: 'Doctoral degree (PhD)' },
    ],
  },
  {
    id: 'canadianEducation',
    label: 'Canadian Study',
    title: 'Do you have a completed Canadian education credential?',
    type: 'single',
    answerKey: 'canadianEducation',
    visibility: baseVisibility,
    options: yesNo,
  },
  {
    id: 'canadianEduType',
    label: 'Canadian Credential',
    title: 'Canadian credential duration',
    type: 'single',
    answerKey: 'canadianEduType',
    visibility: all(neq('knowsScore', 'yes'), eq('canadianEducation', 'yes')),
    options: [
      { value: 'short', label: '1–2 year credential' },
      { value: 'long', label: '3+ year credential or graduate degree' },
    ],
  },
  {
    id: 'workExp',
    label: 'Work Experience',
    title: 'Skilled work experience',
    subtitle: 'Count paid experience in eligible skilled categories.',
    type: 'grouped',
    visibility: baseVisibility,
    groups: [
      { title: 'Foreign skilled work (years)', answerKey: 'foreignWorkExp', type: 'grid-wide', options: workOpts },
      { title: 'Canadian skilled work (years)', answerKey: 'canadianWorkExp', type: 'grid-wide', options: workOpts },
    ],
  },
  {
    id: 'firstOfficialLanguage',
    label: 'First Language',
    title: 'Which is your first official language for CRS?',
    type: 'single',
    answerKey: 'firstOfficialLanguage',
    visibility: baseVisibility,
    options: [
      { value: 'english', label: 'English' },
      { value: 'french', label: 'French' },
    ],
  },
  {
    id: 'hasEnglishSecond',
    label: 'Second Language',
    title: 'Do you also have English test results?',
    subtitle: 'Useful when French is your first official language.',
    type: 'single',
    answerKey: 'hasEnglishSecond',
    visibility: all(neq('knowsScore', 'yes'), eq('firstOfficialLanguage', 'french')),
    options: [
      { value: 'yes', label: 'Yes — IELTS/CELPIP available' },
      { value: 'no', label: 'No — only French results' },
    ],
  },
  {
    id: 'nocTeer',
    label: 'NOC TEER',
    title: 'Select your NOC TEER level',
    subtitle: 'Use search to find your occupation first, then confirm TEER.',
    helpTip: 'Only TEER 0/1/2/3 work experience is usually eligible for Express Entry.',
    type: 'single',
    answerKey: 'nocTeer',
    hasNOCSearch: true,
    searchable: true,
    searchPlaceholder: 'Search TEER options...',
    visibility: advancedVisibility,
    options: nocTEER.map((n) => ({ value: n.value, label: n.label, example: n.examples })),
  },
  {
    id: 'occupationCategory',
    label: 'Category Draws',
    title: 'Which occupation category best matches your role?',
    subtitle: 'Used for category-based draw eligibility checks.',
    type: 'single',
    answerKey: 'occupationCategory',
    visibility: advancedVisibility,
    options: [
      { value: 'healthcare', label: 'Healthcare & Social Services' },
      { value: 'stem', label: 'STEM (Science/Tech/Engineering/Math)' },
      { value: 'trade', label: 'Skilled Trades' },
      { value: 'transport', label: 'Transport' },
      { value: 'agriculture', label: 'Agriculture & Agri-food' },
      { value: 'education', label: 'Education occupations' },
      { value: 'other', label: 'Other / None of the above' },
    ],
  },
  {
    id: 'langTestType',
    label: 'English Test',
    title: 'English language test type',
    subtitle: 'Choose the test used for your English scores.',
    type: 'single',
    answerKey: 'langTestType',
    visibility: allAny(
      [neq('knowsScore', 'yes')],
      [neq('firstOfficialLanguage', 'french'), eq('hasEnglishSecond', 'yes')]
    ),
    options: [
      { value: 'ielts', label: 'IELTS General Training' },
      { value: 'celpip', label: 'CELPIP General' },
      { value: 'none', label: 'No English test yet' },
    ],
  },
  {
    id: 'ielts',
    label: 'IELTS',
    title: 'IELTS score profile',
    type: 'grouped',
    visibility: all(neq('knowsScore', 'yes'), eq('langTestType', 'ielts')),
    groups: [
      { title: 'Listening', answerKey: 'ielts_listening', type: 'grid', options: bandOpts(ieltsBands), searchable: true, searchPlaceholder: 'Filter IELTS bands...' },
      { title: 'Reading', answerKey: 'ielts_reading', type: 'grid', options: bandOpts(ieltsBands), searchable: true, searchPlaceholder: 'Filter IELTS bands...' },
      { title: 'Writing', answerKey: 'ielts_writing', type: 'grid', options: bandOpts(ieltsBands), searchable: true, searchPlaceholder: 'Filter IELTS bands...' },
      { title: 'Speaking', answerKey: 'ielts_speaking', type: 'grid', options: bandOpts(ieltsBands), searchable: true, searchPlaceholder: 'Filter IELTS bands...' },
    ],
  },
  {
    id: 'celpip',
    label: 'CELPIP',
    title: 'CELPIP score profile',
    type: 'grouped',
    visibility: all(neq('knowsScore', 'yes'), eq('langTestType', 'celpip')),
    groups: [
      { title: 'Listening', answerKey: 'celpip_listening', type: 'grid', options: bandOpts(celpipLevels), searchable: true, searchPlaceholder: 'Filter CELPIP levels...' },
      { title: 'Reading', answerKey: 'celpip_reading', type: 'grid', options: bandOpts(celpipLevels), searchable: true, searchPlaceholder: 'Filter CELPIP levels...' },
      { title: 'Writing', answerKey: 'celpip_writing', type: 'grid', options: bandOpts(celpipLevels), searchable: true, searchPlaceholder: 'Filter CELPIP levels...' },
      { title: 'Speaking', answerKey: 'celpip_speaking', type: 'grid', options: bandOpts(celpipLevels), searchable: true, searchPlaceholder: 'Filter CELPIP levels...' },
    ],
  },
  {
    id: 'hasFrench',
    label: 'French Results',
    title: 'Do you have French language test results?',
    type: 'single',
    answerKey: 'hasFrench',
    visibility: all(neq('knowsScore', 'yes'), neq('firstOfficialLanguage', 'french')),
    options: [
      { value: 'yes', label: 'Yes — TEF/TCF or known NCLC levels' },
      { value: 'no', label: 'No French results yet' },
    ],
  },
  {
    id: 'frenchTestType',
    label: 'French Test Type',
    title: 'French test format',
    type: 'single',
    answerKey: 'frenchTestType',
    visibility: allAny(
      [neq('knowsScore', 'yes')],
      [eq('firstOfficialLanguage', 'french'), eq('hasFrench', 'yes')]
    ),
    options: [
      { value: 'tef', label: 'TEF Canada' },
      { value: 'tcf', label: 'TCF Canada' },
      { value: 'clb', label: 'I know NCLC/CLB levels directly' },
    ],
  },
  {
    id: 'tefScores',
    label: 'TEF',
    title: 'TEF score profile',
    type: 'grouped',
    visibility: allAny(
      [neq('knowsScore', 'yes'), eq('frenchTestType', 'tef')],
      [eq('firstOfficialLanguage', 'french'), eq('hasFrench', 'yes')]
    ),
    groups: [
      { title: 'Listening', answerKey: 'tef_listening', type: 'grid-wide', options: bandOpts(tefBands.listening), searchable: true },
      { title: 'Reading', answerKey: 'tef_reading', type: 'grid-wide', options: bandOpts(tefBands.reading), searchable: true },
      { title: 'Writing', answerKey: 'tef_writing', type: 'grid-wide', options: bandOpts(tefBands.writing), searchable: true },
      { title: 'Speaking', answerKey: 'tef_speaking', type: 'grid-wide', options: bandOpts(tefBands.speaking), searchable: true },
    ],
  },
  {
    id: 'tcfScores',
    label: 'TCF',
    title: 'TCF score profile',
    type: 'grouped',
    visibility: allAny(
      [neq('knowsScore', 'yes'), eq('frenchTestType', 'tcf')],
      [eq('firstOfficialLanguage', 'french'), eq('hasFrench', 'yes')]
    ),
    groups: [
      { title: 'Listening', answerKey: 'tcf_listening', type: 'grid-wide', options: bandOpts(tcfBands.listening), searchable: true },
      { title: 'Reading', answerKey: 'tcf_reading', type: 'grid-wide', options: bandOpts(tcfBands.reading), searchable: true },
      { title: 'Writing', answerKey: 'tcf_writing', type: 'grid-wide', options: bandOpts(tcfBands.writing), searchable: true },
      { title: 'Speaking', answerKey: 'tcf_speaking', type: 'grid-wide', options: bandOpts(tcfBands.speaking), searchable: true },
    ],
  },
  {
    id: 'frenchScores',
    label: 'French NCLC',
    title: 'French NCLC/CLB profile',
    type: 'grouped',
    visibility: allAny(
      [neq('knowsScore', 'yes'), eq('frenchTestType', 'clb')],
      [eq('firstOfficialLanguage', 'french'), eq('hasFrench', 'yes')]
    ),
    groups: [
      { title: 'Listening', answerKey: 'french_listening', type: 'grid', options: clbOpts, searchable: true },
      { title: 'Reading', answerKey: 'french_reading', type: 'grid', options: clbOpts, searchable: true },
      { title: 'Writing', answerKey: 'french_writing', type: 'grid', options: clbOpts, searchable: true },
      { title: 'Speaking', answerKey: 'french_speaking', type: 'grid', options: clbOpts, searchable: true },
    ],
  },
  {
    id: 'hasSpouse',
    label: 'Spouse',
    title: 'Do you have a spouse/common-law partner?',
    type: 'single',
    answerKey: 'hasSpouse',
    visibility: baseVisibility,
    options: yesNo,
  },
  {
    id: 'spouseIsCanadian',
    label: 'Spouse Status',
    title: 'Is your spouse a Canadian citizen or PR?',
    type: 'single',
    answerKey: 'spouseIsCanadian',
    visibility: all(neq('knowsScore', 'yes'), eq('hasSpouse', 'yes')),
    options: [
      { value: 'yes', label: 'Yes — Canadian citizen/PR' },
      { value: 'no', label: 'No' },
    ],
  },
  {
    id: 'spouseAccompanying',
    label: 'Accompanying',
    title: 'Will your spouse accompany you to Canada?',
    type: 'single',
    answerKey: 'spouseAccompanying',
    visibility: all(neq('knowsScore', 'yes'), eq('hasSpouse', 'yes'), neq('spouseIsCanadian', 'yes')),
    options: [
      { value: 'yes', label: 'Yes — accompanying' },
      { value: 'no', label: 'No — non-accompanying' },
    ],
  },
  {
    id: 'spouseDetails',
    label: 'Spouse Factors',
    title: 'Spouse profile details',
    type: 'grouped',
    visibility: all(
      neq('knowsScore', 'yes'),
      eq('hasSpouse', 'yes'),
      neq('spouseIsCanadian', 'yes'),
      eq('spouseAccompanying', 'yes')
    ),
    groups: [
      {
        title: 'Spouse education',
        answerKey: 'spouseEducation',
        type: 'single',
        options: [
          { value: 'less_than_secondary', label: 'Less than high school' },
          { value: 'secondary', label: 'High school' },
          { value: 'one_year_post', label: '1-year post-secondary credential' },
          { value: 'two_year_post', label: '2-year post-secondary credential' },
          { value: 'bachelors', label: 'Bachelor’s degree' },
          { value: 'two_or_more', label: 'Two or more credentials' },
          { value: 'masters', label: 'Master’s / Professional degree' },
          { value: 'doctoral', label: 'Doctoral degree' },
        ],
      },
      { title: 'Spouse CLB — Listening', answerKey: 'spouseLang_listening', type: 'grid', options: clbOpts, searchable: true },
      { title: 'Spouse CLB — Reading', answerKey: 'spouseLang_reading', type: 'grid', options: clbOpts, searchable: true },
      { title: 'Spouse CLB — Writing', answerKey: 'spouseLang_writing', type: 'grid', options: clbOpts, searchable: true },
      { title: 'Spouse CLB — Speaking', answerKey: 'spouseLang_speaking', type: 'grid', options: clbOpts, searchable: true },
      { title: 'Spouse Canadian work (years)', answerKey: 'spouseCanadianWork', type: 'grid-wide', options: workOpts },
    ],
  },
  {
    id: 'hasJobOffer',
    label: 'Job Offer',
    title: 'Do you have a valid Canadian job offer?',
    subtitle: 'Useful for pathway planning, even after CRS changes to arranged employment points.',
    type: 'single',
    answerKey: 'hasJobOffer',
    visibility: advancedVisibility,
    options: [
      { value: 'yes', label: 'Yes — valid offer available' },
      { value: 'no', label: 'No valid offer yet' },
    ],
  },
  {
    id: 'jobOfferDetails',
    label: 'Job Offer Details',
    title: 'Job offer details',
    subtitle: 'Follow-up based on your job-offer answer.',
    type: 'grouped',
    visibility: all(neq('knowsScore', 'yes'), eq('answerMode', 'advanced'), eq('hasJobOffer', 'yes')),
    groups: [
      {
        title: 'Offer type',
        answerKey: 'jobOfferType',
        type: 'single',
        options: [
          { value: 'lmia_supported', label: 'LMIA-supported offer' },
          { value: 'lmia_exempt', label: 'LMIA-exempt employer-specific offer' },
          { value: 'public_policy', label: 'Public policy / open permit path' },
          { value: 'unknown', label: 'Not sure' },
        ],
      },
      {
        title: 'Offer NOC TEER',
        answerKey: 'jobOfferTeer',
        type: 'single',
        options: [
          { value: 'teer_0', label: 'TEER 0' },
          { value: 'teer_1', label: 'TEER 1' },
          { value: 'teer_2', label: 'TEER 2' },
          { value: 'teer_3', label: 'TEER 3' },
          { value: 'teer_4', label: 'TEER 4' },
          { value: 'teer_5', label: 'TEER 5' },
          { value: 'unknown', label: 'Unknown' },
        ],
      },
    ],
  },
  {
    id: 'hasCertificate',
    label: 'Trade Certificate',
    title: 'Do you hold a Canadian trade certificate of qualification?',
    type: 'single',
    answerKey: 'hasCertificate',
    visibility: all(neq('knowsScore', 'yes'), eq('pathway', 'fst')),
    options: yesNo,
  },
  {
    id: 'hasPNP',
    label: 'PNP',
    title: 'Do you already have a provincial nomination?',
    subtitle: 'A PNP nomination typically adds 600 CRS points.',
    type: 'single',
    answerKey: 'hasPNP',
    visibility: baseVisibility,
    options: [
      { value: 'yes', label: 'Yes — nominated' },
      { value: 'no', label: 'No nomination yet' },
    ],
  },
  {
    id: 'pnpNominationProvince',
    label: 'PNP Province',
    title: 'Which province nominated you?',
    type: 'single',
    answerKey: 'pnpNominationProvince',
    searchable: true,
    searchPlaceholder: 'Search nominated province...',
    visibility: all(neq('knowsScore', 'yes'), eq('hasPNP', 'yes')),
    options: provinceOptions,
  },
  {
    id: 'hasSibling',
    label: 'Sibling in Canada',
    title: 'Do you have a sibling in Canada (citizen/PR, 18+)?',
    type: 'single',
    answerKey: 'hasSibling',
    visibility: baseVisibility,
    options: yesNo,
  },
  {
    id: 'currentResidenceCountry',
    label: 'Residence Country',
    title: 'Where are you currently living?',
    subtitle: 'Used for planning tasks and region-specific prep guidance.',
    type: 'single',
    answerKey: 'currentResidenceCountry',
    searchable: true,
    searchPlaceholder: 'Search country...',
    visibility: advancedVisibility,
    options: countryOptions,
  },
  {
    id: 'currentStatusInCanada',
    label: 'Current Status',
    title: 'Current status in Canada',
    type: 'single',
    answerKey: 'currentStatusInCanada',
    visibility: all(neq('knowsScore', 'yes'), eq('answerMode', 'advanced'), eq('currentResidenceCountry', 'canada')),
    options: [
      { value: 'not_in_canada', label: 'Not currently in Canada' },
      { value: 'visitor', label: 'Visitor' },
      { value: 'student', label: 'International student' },
      { value: 'worker_closed', label: 'Worker (closed work permit)' },
      { value: 'worker_open', label: 'Worker (open work permit)' },
      { value: 'implied_status', label: 'Maintained/implied status' },
      { value: 'pr_or_citizen_spouse', label: 'With spouse who is PR/citizen' },
      { value: 'other', label: 'Other / Prefer not to say' },
    ],
  },
  {
    id: 'workPermitTimeline',
    label: 'Work Permit Timeline',
    title: 'When does your current work authorization expire?',
    type: 'single',
    answerKey: 'workPermitTimeline',
    visibility: all(
      neq('knowsScore', 'yes'),
      eq('answerMode', 'advanced'),
      eq('currentResidenceCountry', 'canada'),
      inList('currentStatusInCanada', ['worker_closed', 'worker_open', 'implied_status'])
    ),
    options: [
      { value: 'lt_3m', label: 'Within 3 months' },
      { value: '3_6m', label: '3–6 months' },
      { value: '6_12m', label: '6–12 months' },
      { value: '12m_plus', label: 'More than 12 months' },
      { value: 'unsure', label: 'Not sure' },
    ],
  },
  {
    id: 'targetProvince',
    label: 'Target Province',
    title: 'Preferred province/territory of settlement',
    type: 'single',
    answerKey: 'targetProvince',
    searchable: true,
    searchPlaceholder: 'Search province...',
    visibility: baseVisibility,
    options: provinceOptions,
  },
  {
    id: 'settlementFundsRange',
    label: 'Settlement Funds',
    title: 'Estimated available settlement funds (CAD)',
    subtitle: 'Used for planning and readiness checks.',
    type: 'single',
    answerKey: 'settlementFundsRange',
    visibility: all(neq('knowsScore', 'yes'), inList('pathway', ['fsw', 'fst', 'other', 'aip', 'pnp', 'cec'])),
    options: [
      { value: 'lt_5000', label: 'Under $5,000' },
      { value: '5000_9999', label: '$5,000–$9,999' },
      { value: '10000_14999', label: '$10,000–$14,999' },
      { value: '15000_19999', label: '$15,000–$19,999' },
      { value: '20000_24999', label: '$20,000–$24,999' },
      { value: '25000_34999', label: '$25,000–$34,999' },
      { value: '35000_49999', label: '$35,000–$49,999' },
      { value: '50000_plus', label: '$50,000+' },
    ],
  },
  {
    id: 'ecaStatus',
    label: 'ECA',
    title: 'Educational Credential Assessment (ECA) status',
    type: 'single',
    answerKey: 'ecaStatus',
    visibility: baseVisibility,
    options: [
      { value: 'not_needed', label: 'Not needed (Canadian education only)' },
      { value: 'completed', label: 'Completed and valid' },
      { value: 'in_progress', label: 'In progress' },
      { value: 'not_started', label: 'Not started yet' },
      { value: 'expired_or_unclear', label: 'Expired / unsure validity' },
    ],
  },
  {
    id: 'expressEntryProfileStatus',
    label: 'EE Profile',
    title: 'Express Entry profile status',
    type: 'single',
    answerKey: 'expressEntryProfileStatus',
    visibility: advancedVisibility,
    options: [
      { value: 'active_pool', label: 'Created and active in pool' },
      { value: 'draft', label: 'Started but not submitted' },
      { value: 'not_created', label: 'Not created yet' },
      { value: 'expired', label: 'Expired profile' },
      { value: 'invited', label: 'Already invited (ITA received)' },
    ],
  },
  {
    id: 'biometricsStatus',
    label: 'Biometrics',
    title: 'Biometrics status',
    type: 'single',
    answerKey: 'biometricsStatus',
    visibility: advancedVisibility,
    options: [
      { value: 'valid', label: 'Already valid' },
      { value: 'scheduled', label: 'Appointment scheduled' },
      { value: 'not_started', label: 'Not started' },
      { value: 'expired', label: 'Expired / needs renewal' },
      { value: 'na', label: 'Not sure / not applicable yet' },
    ],
  },
  {
    id: 'medicalExamStatus',
    label: 'Medical',
    title: 'Immigration medical exam status',
    type: 'single',
    answerKey: 'medicalExamStatus',
    visibility: advancedVisibility,
    options: [
      { value: 'completed_valid', label: 'Completed and valid' },
      { value: 'scheduled', label: 'Scheduled' },
      { value: 'not_started', label: 'Not started' },
      { value: 'expired', label: 'Expired / needs redo' },
      { value: 'na', label: 'Not sure / not applicable yet' },
    ],
  },
  {
    id: 'policeCertificateStatus',
    label: 'Police Certs',
    title: 'Police certificate readiness',
    type: 'single',
    answerKey: 'policeCertificateStatus',
    visibility: advancedVisibility,
    options: [
      { value: 'all_ready', label: 'All required certificates ready' },
      { value: 'partially_ready', label: 'Some certificates ready' },
      { value: 'not_started', label: 'Not started' },
      { value: 'waiting_issued', label: 'Applied, waiting issuance' },
      { value: 'unsure', label: 'Unsure requirements' },
    ],
  },
  {
    id: 'passportValidity',
    label: 'Passport',
    title: 'Passport validity at expected application time',
    type: 'single',
    answerKey: 'passportValidity',
    visibility: baseVisibility,
    options: [
      { value: 'gt_24', label: 'More than 24 months' },
      { value: '12_24', label: '12–24 months' },
      { value: '6_12', label: '6–12 months' },
      { value: 'lt_6', label: 'Less than 6 months' },
      { value: 'renewal_in_progress', label: 'Renewal in progress' },
    ],
  },
  {
    id: 'documentsTimeline',
    label: 'Readiness Timeline',
    title: 'When do you want to be fully application-ready?',
    type: 'single',
    answerKey: 'documentsTimeline',
    visibility: baseVisibility,
    options: [
      { value: 'lt_3m', label: 'Within 3 months' },
      { value: '3_6m', label: '3–6 months' },
      { value: '6_12m', label: '6–12 months' },
      { value: '12_24m', label: '12–24 months' },
      { value: 'exploring_only', label: 'Exploring only (no fixed timeline)' },
    ],
  },
];

export function countQuestionPrompts(steps = fallbackQuestionBank) {
  return steps.reduce((sum, step) => {
    if (step.type === 'grouped' && Array.isArray(step.groups)) {
      return sum + step.groups.length;
    }
    return sum + 1;
  }, 0);
}

